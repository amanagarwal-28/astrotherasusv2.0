<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASTRO THESAURUS ‚Äî REBOUND Engine</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;900&family=JetBrains+Mono:wght@300;400;500&family=Space+Grotesk:wght@300;400;500;600&display=swap');

    :root {
      --void: #000010;
      --panel: #03091e;
      --panel2: #040c22;
      --border: rgba(50, 130, 255, 0.16);
      --border-teal: rgba(0, 220, 180, 0.22);
      --accent: #3280ff;
      --pulse: #00e5ff;
      --teal: #00dcb4;
      --nova: #ff1a6e;
      --green: #00ff88;
      --gold: #ffd700;
      --text: #dde8ff;
      --dim: #7a9abf;
      --bright: #fff;
      --hl-bg: #020a1c;
      --hl-border: #00dcb4;
    }

    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      background: var(--void);
      color: var(--text);
      font-family: 'Space Grotesk', sans-serif;
      overflow: hidden;
    }

    #stars {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 1;
      pointer-events: none;
      background-image:
        linear-gradient(rgba(50, 128, 255, 0.022) 1px, transparent 1px),
        linear-gradient(90deg, rgba(50, 128, 255, 0.022) 1px, transparent 1px);
      background-size: 44px 44px;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LAYOUT: header ribbon + 2 columns
   Left col = simulation canvas (fills all)
   Right col = chat sidebar (full height)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .app {
      position: relative;
      z-index: 2;
      display: grid;
      grid-template-rows: 58px 1fr;
      grid-template-columns: 1fr 380px;
      height: 100vh;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER RIBBON ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    header {
      grid-column: 1 / 2;
      /* only spans sim column */
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 0 16px;
      background: rgba(2, 5, 24, 0.98);
      border-bottom: 1px solid var(--border);
      border-right: 1px solid var(--border);
      position: relative;
      z-index: 50;
    }

    header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--pulse) 40%, var(--teal) 70%, transparent);
      opacity: 0.5;
    }

    /* Logo */
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .logo-ring {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 1.5px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      box-shadow: 0 0 14px rgba(50, 128, 255, .4);
      animation: gp 3s ease-in-out infinite;
    }

    @keyframes gp {

      0%,
      100% {
        box-shadow: 0 0 14px rgba(50, 128, 255, .35);
      }

      50% {
        box-shadow: 0 0 28px rgba(50, 128, 255, .7);
      }
    }

    .logo-name {
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: 3px;
      background: linear-gradient(90deg, #fff, var(--pulse), var(--teal));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .logo-sub {
      font-size: 7.5px;
      letter-spacing: 2px;
      color: rgba(130, 165, 220, 0.8);
      font-weight: 600;
    }

    /* Centre search ‚Äî Quick Simulate */
    .sim-bar {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }

    .sim-bar-tag {
      font-family: 'Orbitron', sans-serif;
      font-size: 7px;
      letter-spacing: 2px;
      color: var(--teal);
      text-transform: uppercase;
      white-space: nowrap;
      padding: 4px 9px;
      border: 1px solid var(--border-teal);
      border-radius: 3px;
      background: rgba(0, 220, 180, 0.06);
    }

    .sim-bar-wrap {
      flex: 1;
      position: relative;
    }

    #sim-input {
      width: 100%;
      padding: 9px 44px 9px 13px;
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid var(--border-teal);
      border-radius: 4px;
      color: var(--bright);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 11.5px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    #sim-input:focus {
      border-color: var(--teal);
      box-shadow: 0 0 0 2px rgba(0, 220, 180, 0.1), 0 0 18px rgba(0, 220, 180, 0.12);
    }

    #sim-input::placeholder {
      color: rgba(120, 160, 200, 0.85);
      font-size: 11px;
    }

    #sim-go {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      width: 30px;
      height: 30px;
      background: linear-gradient(135deg, var(--teal), #009070);
      border: none;
      border-radius: 3px;
      color: #000;
      font-size: 13px;
      font-weight: 900;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .18s;
    }

    #sim-go:hover {
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 0 14px rgba(0, 220, 180, .5);
    }

    #sim-go:disabled {
      opacity: .35;
      cursor: not-allowed;
      transform: translateY(-50%);
    }

    /* Suggestion dropdown */
    #sim-sugg {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      z-index: 200;
      background: rgba(2, 6, 24, 0.99);
      border: 1px solid rgba(0, 220, 180, 0.35);
      border-radius: 5px;
      overflow: hidden;
      display: none;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7), 0 0 20px rgba(0, 220, 180, 0.06);
      backdrop-filter: blur(16px);
    }

    #sim-sugg.open {
      display: block;
    }

    .sugg-head {
      padding: 6px 13px 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 6.5px;
      letter-spacing: 2.5px;
      color: rgba(0, 220, 180, 0.45);
      text-transform: uppercase;
      border-bottom: 1px solid rgba(0, 220, 180, 0.08);
    }

    .sugg-item {
      padding: 9px 13px;
      display: flex;
      align-items: center;
      gap: 9px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: rgba(180, 215, 255, 0.8);
      cursor: pointer;
      transition: all .12s;
      border-bottom: 1px solid rgba(0, 220, 180, 0.05);
    }

    .sugg-item:last-child {
      border-bottom: none;
    }

    .sugg-item:hover {
      background: rgba(0, 220, 180, 0.07);
      color: var(--teal);
      padding-left: 17px;
    }

    .sugg-ic {
      font-size: 13px;
      flex-shrink: 0;
    }

    /* Header stats (right of header) */
    .hstats {
      display: flex;
      gap: 5px;
      align-items: center;
      flex-shrink: 0;
    }

    .hs {
      padding: 4px 10px;
      border: 1px solid var(--border);
      border-radius: 2px;
      background: rgba(50, 128, 255, .04);
      text-align: center;
    }

    .hs-l {
      display: block;
      font-size: 6px;
      letter-spacing: 2px;
      color: rgba(140, 175, 230, 0.8);
      text-transform: uppercase;
    }

    .hs-v {
      font-family: 'Orbitron', sans-serif;
      font-size: 10px;
      color: var(--pulse);
      font-weight: 700;
    }

    .pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 11px;
      border: 1px solid rgba(0, 255, 136, .22);
      border-radius: 20px;
      background: rgba(0, 255, 136, .04);
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 7px var(--green);
      animation: bl 2s ease-in-out infinite;
    }

    @keyframes bl {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: .2;
      }
    }

    .pill-t {
      font-size: 7.5px;
      letter-spacing: 1px;
      color: var(--green);
      text-transform: uppercase;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SECTION HEADER ‚Äî dark highlight style ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .sec-hdr {
      display: flex;
      align-items: center;
      gap: 0;
      height: 36px;
      flex-shrink: 0;
      background: var(--hl-bg);
      border-bottom: 1px solid rgba(0, 220, 180, 0.14);
      border-left: 3px solid var(--hl-border);
      padding: 0 14px;
      position: relative;
    }

    .sec-hdr::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, rgba(0, 220, 180, 0.3), transparent 60%);
    }

    .sec-hdr-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 8px;
      font-weight: 900;
      letter-spacing: 3px;
      color: var(--teal);
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .sec-hdr-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--teal);
      box-shadow: 0 0 7px var(--teal);
      animation: bl 2s infinite;
    }

    .sec-hdr-sp {
      flex: 1;
    }

    .sec-hdr-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 7.5px;
      letter-spacing: 1px;
      color: rgba(0, 220, 180, 0.85);
      padding: 3px 9px;
      border: 1px solid rgba(0, 220, 180, 0.35);
      border-radius: 8px;
      background: rgba(0, 220, 180, 0.08);
    }

    /* Gold variant for Orbital Plot */
    .sec-hdr.gold {
      border-left-color: var(--gold);
    }

    .sec-hdr.gold .sec-hdr-title {
      color: var(--gold);
    }

    .sec-hdr.gold .sec-hdr-dot {
      background: var(--gold);
      box-shadow: 0 0 7px var(--gold);
    }

    .sec-hdr.gold::after {
      background: linear-gradient(90deg, rgba(255, 215, 0, 0.25), transparent 60%);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CENTER (simulation) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    #center {
      display: flex;
      flex-direction: column;
      background: var(--void);
      overflow: hidden;
      /* no border-right ‚Äî chat is adjacent */
    }

    /* Sim options bar (just below header, above canvas) */
    #sim-opts {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 5px 12px;
      background: rgba(2, 5, 20, 0.97);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    .btn {
      padding: 5px 10px;
      border: 1px solid var(--border);
      border-radius: 3px;
      background: rgba(0, 0, 0, .35);
      color: rgba(160, 195, 255, 0.8);
      font-family: 'JetBrains Mono', monospace;
      font-size: 7.5px;
      cursor: pointer;
      transition: all .15s;
      letter-spacing: 1px;
      white-space: nowrap;
    }

    .btn:hover {
      border-color: var(--teal);
      color: var(--text);
    }

    .btn.on {
      background: rgba(0, 220, 180, .1);
      border-color: var(--teal);
      color: var(--teal);
    }

    .btn.red {
      border-color: rgba(255, 26, 110, .3);
      color: var(--nova);
    }

    .btn.red:hover {
      background: rgba(255, 26, 110, .08);
    }

    .opts-sep {
      width: 1px;
      height: 20px;
      background: var(--border);
      margin: 0 3px;
      flex-shrink: 0;
    }

    .sl-inline {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .sl-lbl-s {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      color: rgba(180, 210, 255, 0.85);
      letter-spacing: 1px;
      white-space: nowrap;
    }

    .sl-val {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      color: var(--teal);
      min-width: 24px;
      font-weight: 600;
    }

    input[type=range] {
      width: 70px;
      accent-color: var(--teal);
      height: 3px;
      cursor: pointer;
    }

    /* Status bar ‚Äî always fully visible */
    #status-bar {
      padding: 5px 14px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 8.5px;
      letter-spacing: 0.5px;
      color: rgba(200, 220, 255, 0.9);
      /* high contrast, no focus needed */
      border-bottom: 1px solid rgba(50, 128, 255, 0.1);
      min-height: 26px;
      display: flex;
      align-items: center;
      gap: 7px;
      background: rgba(1, 4, 18, 0.75);
      flex-shrink: 0;
      z-index: 10;
    }

    #status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--dim);
      flex-shrink: 0;
    }

    #status-dot.ok {
      background: var(--green);
      box-shadow: 0 0 8px var(--green);
    }

    #status-dot.err {
      background: var(--nova);
      box-shadow: 0 0 8px var(--nova);
    }

    #status-dot.spin {
      background: #ffaa00;
      animation: bl .6s infinite;
    }

    /* VIEW TABS inside section header */
    .vtab-group {
      display: flex;
      align-items: stretch;
      height: 100%;
      gap: 0;
    }

    .vtab {
      padding: 0 16px;
      font-family: 'Orbitron', sans-serif;
      font-size: 7.5px;
      letter-spacing: 2px;
      border: none;
      border-right: 1px solid rgba(50, 128, 255, 0.12);
      background: transparent;
      color: rgba(130, 160, 210, 0.85);
      cursor: pointer;
      transition: all .2s;
      display: flex;
      align-items: center;
      gap: 6px;
      position: relative;
    }

    .vtab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: transparent;
      transition: background .2s;
    }

    .vtab.active {
      color: var(--teal);
      background: rgba(0, 220, 180, 0.06);
    }

    .vtab.active::after {
      background: var(--teal);
    }

    .vtab.gold-tab.active {
      color: var(--gold);
      background: rgba(255, 215, 0, 0.04);
    }

    .vtab.gold-tab.active::after {
      background: var(--gold);
    }

    .vtab:hover:not(.active) {
      color: rgba(180, 210, 255, 0.65);
      background: rgba(255, 255, 255, 0.015);
    }

    #canvas-wrap {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    #sim-canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    .cv-corner {
      position: absolute;
      pointer-events: none;
      width: 14px;
      height: 14px;
    }

    .cv-corner.tl {
      top: 10px;
      left: 10px;
      border-top: 1px solid rgba(0, 220, 180, 0.3);
      border-left: 1px solid rgba(0, 220, 180, 0.3);
    }

    .cv-corner.tr {
      top: 10px;
      right: 10px;
      border-top: 1px solid rgba(0, 220, 180, 0.3);
      border-right: 1px solid rgba(0, 220, 180, 0.3);
    }

    .cv-corner.bl {
      bottom: 10px;
      left: 10px;
      border-bottom: 1px solid rgba(0, 220, 180, 0.3);
      border-left: 1px solid rgba(0, 220, 180, 0.3);
    }

    .cv-corner.br {
      bottom: 10px;
      right: 10px;
      border-bottom: 1px solid rgba(0, 220, 180, 0.3);
      border-right: 1px solid rgba(0, 220, 180, 0.3);
    }

    .cv-hud {
      position: absolute;
      font-family: 'JetBrains Mono', monospace;
      font-size: 7.5px;
      letter-spacing: 1px;
      color: rgba(0, 220, 180, 0.38);
      text-transform: uppercase;
      line-height: 1.9;
      pointer-events: none;
    }

    #hud-tl {
      top: 14px;
      left: 14px;
    }

    #hud-tr {
      top: 14px;
      right: 14px;
      text-align: right;
    }

    #hud-bl {
      bottom: 14px;
      left: 14px;
    }

    #watermark {
      position: absolute;
      bottom: 44px;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Orbitron', sans-serif;
      font-size: 28px;
      font-weight: 900;
      color: rgba(255, 255, 255, 0.018);
      letter-spacing: 8px;
      white-space: nowrap;
      pointer-events: none;
    }

    #empty-state {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: none;
    }

    .es-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 17px;
      font-weight: 900;
      letter-spacing: 6px;
      text-transform: uppercase;
      margin-bottom: 14px;
      background: linear-gradient(135deg, #fff 0%, var(--pulse) 50%, var(--teal) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 0 18px rgba(0, 220, 180, 0.35));
    }

    .es-txt {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: 2px;
      color: rgba(200, 225, 255, 0.75);
      line-height: 2.2;
      text-shadow: 0 0 12px rgba(0, 180, 255, 0.3);
    }

    .es-divider {
      width: 60px;
      height: 1px;
      margin: 14px auto;
      background: linear-gradient(90deg, transparent, var(--teal), transparent);
      opacity: 0.5;
    }

    #plot-wrap {
      flex: 1;
      display: none;
      align-items: center;
      justify-content: center;
      background: var(--void);
      padding: 14px;
    }

    #plot-img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 5px;
      border: 1px solid var(--border);
      box-shadow: 0 0 40px rgba(50, 128, 255, .1);
      display: none;
    }

    #plot-empty {
      text-align: center;
      pointer-events: none;
    }

    .pe-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 17px;
      font-weight: 900;
      letter-spacing: 6px;
      text-transform: uppercase;
      margin-bottom: 14px;
      background: linear-gradient(135deg, #fff 0%, var(--gold) 60%, #ffaa00 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 0 18px rgba(255, 215, 0, 0.3));
    }

    .pe-divider {
      width: 60px;
      height: 1px;
      margin: 14px auto;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
      opacity: 0.5;
    }

    .pe-txt {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: 2px;
      color: rgba(200, 225, 255, 0.75);
      line-height: 2.2;
      text-shadow: 0 0 12px rgba(255, 200, 0, 0.2);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RIGHT PANEL ‚Äî full height, spans both rows ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    #right {
      grid-row: 1 / -1;
      /* span header row AND content row */
      grid-column: 2 / 3;
      background: var(--panel2);
      border-left: 1px solid var(--border-teal);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    #right::before {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background: radial-gradient(ellipse at 50% 0%, rgba(0, 220, 180, 0.04) 0%, transparent 55%);
    }

    #right>* {
      position: relative;
      z-index: 1;
    }

    /* Chat messages */
    #chat-msgs {
      flex: 1;
      overflow-y: auto;
      padding: 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 9px;
      scroll-behavior: smooth;
    }

    #chat-msgs::-webkit-scrollbar {
      width: 2px;
    }

    #chat-msgs::-webkit-scrollbar-thumb {
      background: rgba(0, 220, 180, 0.3);
      border-radius: 2px;
    }

    .welcome {
      padding: 13px;
      border-radius: 5px;
      background: linear-gradient(135deg, rgba(0, 220, 180, 0.05), rgba(50, 128, 255, 0.03));
      border: 1px solid rgba(0, 220, 180, 0.14);
      position: relative;
      overflow: hidden;
    }

    .welcome::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--teal), transparent);
      opacity: 0.6;
    }

    .wc-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 8.5px;
      letter-spacing: 2px;
      color: var(--teal);
      margin-bottom: 7px;
    }

    .wc-body {
      font-size: 10.5px;
      color: rgba(200, 220, 255, 0.82);
      line-height: 1.85;
    }

    .wc-exs {
      margin-top: 9px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .wce {
      padding: 6px 9px;
      font-size: 9.5px;
      border: 1px solid rgba(0, 220, 180, 0.1);
      border-radius: 3px;
      color: rgba(0, 220, 180, 0.55);
      cursor: pointer;
      transition: all .15s;
      background: rgba(0, 0, 0, 0.22);
      font-family: 'JetBrains Mono', monospace;
    }

    .wce:hover {
      border-color: var(--teal);
      color: var(--teal);
      background: rgba(0, 220, 180, 0.05);
      transform: translateX(3px);
    }

    /* Messages */
    .msg {
      animation: mi .22s ease;
    }

    @keyframes mi {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: none;
      }
    }

    .msg-u {
      align-self: flex-end;
      max-width: 90%;
      padding: 9px 13px;
      font-size: 11px;
      line-height: 1.65;
      background: rgba(50, 128, 255, .1);
      border: 1px solid rgba(50, 128, 255, .22);
      border-radius: 7px 7px 2px 7px;
      color: var(--bright);
    }

    .msg-a {
      width: 100%;
      padding: 11px 13px;
      font-size: 11px;
      line-height: 1.85;
      background: rgba(0, 220, 180, .04);
      border: 1px solid rgba(0, 220, 180, .1);
      border-radius: 2px 7px 7px 7px;
      color: var(--text);
      position: relative;
    }

    .msg-a-tag {
      position: absolute;
      top: -8px;
      left: 7px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 6.5px;
      letter-spacing: 2px;
      color: var(--teal);
      background: var(--panel2);
      padding: 1px 6px;
      border: 1px solid rgba(0, 220, 180, .18);
      border-radius: 2px;
    }

    .msg-sys {
      align-self: center;
      font-family: 'JetBrains Mono', monospace;
      font-size: 7.5px;
      letter-spacing: 2px;
      color: rgba(160, 195, 255, 0.75);
      padding: 2px 9px;
      border: 1px solid rgba(50, 128, 255, .16);
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      text-transform: uppercase;
    }

    .msg-err {
      padding: 9px 13px;
      font-size: 10px;
      background: rgba(255, 26, 110, .06);
      border: 1px solid rgba(255, 26, 110, .18);
      border-radius: 4px;
      color: var(--nova);
    }

    .chat-plot {
      width: 100%;
      border-radius: 3px;
      border: 1px solid var(--border);
      display: block;
      margin-top: 7px;
      cursor: pointer;
    }

    .dtable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 7px;
      font-size: 9px;
    }

    .dtable td {
      padding: 3px 5px;
      border-bottom: 1px solid rgba(0, 220, 180, 0.05);
    }

    .dtable td:first-child {
      color: rgba(160, 190, 230, 0.85);
    }

    .dtable td:last-child {
      color: var(--teal);
      text-align: right;
      font-family: 'JetBrains Mono', monospace;
    }

    .typing {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 11px 13px;
    }

    .typing span {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--teal);
      animation: td 1.2s ease-in-out infinite;
      opacity: 0.4;
    }

    .typing span:nth-child(2) {
      animation-delay: .2s;
    }

    .typing span:nth-child(3) {
      animation-delay: .4s;
    }

    @keyframes td {

      0%,
      60%,
      100% {
        transform: translateY(0);
        opacity: .3;
      }

      30% {
        transform: translateY(-5px);
        opacity: 1;
      }
    }

    /* Replay button */
    .btn-replay {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-top: 8px;
      padding: 5px 10px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 7.5px;
      letter-spacing: 1px;
      background: rgba(255, 215, 0, 0.07);
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 3px;
      color: var(--gold);
      cursor: pointer;
      transition: all .15s;
    }

    .btn-replay:hover {
      background: rgba(255, 215, 0, 0.14);
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.18);
    }

    .btn-replay-icon {
      font-size: 10px;
    }

    /* Input area */
    #input-area {
      padding: 9px 10px;
      border-top: 1px solid var(--border-teal);
      background: rgba(1, 5, 18, 0.85);
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex-shrink: 0;
    }

    /* API status row ‚Äî high visibility, above input */
    .api-row {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 5px 9px;
      border: 1px solid rgba(0, 220, 180, 0.18);
      border-radius: 3px;
      background: rgba(0, 220, 180, 0.03);
    }

    .api-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .api-dot.on {
      background: var(--green);
      box-shadow: 0 0 7px var(--green);
    }

    .api-dot.off {
      background: #ff4444;
      box-shadow: 0 0 5px #ff4444;
    }

    .api-dot.wait {
      background: #ffaa00;
      animation: bl 1s infinite;
    }

    .api-lbl {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8.5px;
      letter-spacing: 0.5px;
      color: rgba(200, 235, 220, 0.95);
      text-transform: uppercase;
    }

    .inp-row {
      display: flex;
      gap: 5px;
      align-items: flex-end;
    }

    #chat-in {
      flex: 1;
      background: rgba(0, 0, 0, .45);
      border: 1px solid rgba(0, 220, 180, 0.18);
      border-radius: 4px;
      color: var(--bright);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 11px;
      padding: 8px 11px;
      resize: none;
      min-height: 38px;
      max-height: 85px;
      outline: none;
      transition: border-color .2s;
      line-height: 1.5;
    }

    #chat-in:focus {
      border-color: var(--teal);
    }

    #chat-in::placeholder {
      color: rgba(120, 155, 200, 0.8);
      font-size: 10px;
    }

    #send {
      width: 38px;
      height: 38px;
      flex-shrink: 0;
      background: linear-gradient(135deg, var(--teal), #009070);
      border: none;
      border-radius: 4px;
      color: #000;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .18s;
      font-weight: 900;
    }

    #send:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 18px rgba(0, 220, 180, .4);
    }

    #send:disabled {
      opacity: .4;
      cursor: not-allowed;
      transform: none;
    }

    /* ====== SCREENSHOT + NASA BUTTONS ====== */
    .btn-screenshot {
      padding: 4px 10px;
      background: rgba(0, 220, 180, 0.08);
      border: 1px solid rgba(0, 220, 180, 0.3);
      border-radius: 3px;
      color: var(--teal);
      font-size: 9px;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap;
    }

    .btn-screenshot:hover {
      background: rgba(0, 220, 180, 0.18);
      box-shadow: 0 0 10px rgba(0, 220, 180, 0.2);
    }

    .btn-nasa {
      padding: 4px 10px;
      background: rgba(50, 128, 255, 0.08);
      border: 1px solid rgba(50, 128, 255, 0.3);
      border-radius: 3px;
      color: var(--accent);
      font-size: 9px;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap;
    }

    .btn-nasa:hover {
      background: rgba(50, 128, 255, 0.18);
      box-shadow: 0 0 10px rgba(50, 128, 255, 0.2);
    }

    .btn-nasa:disabled {
      opacity: .4;
      cursor: not-allowed;
    }

    /* ====== COLLISION FLASH ====== */
    #collision-flash {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0;
      background: radial-gradient(ellipse at center,
          rgba(255, 200, 50, 0.45) 0%, rgba(255, 100, 20, 0.2) 40%, transparent 70%);
      transition: opacity 0.05s ease-in;
      z-index: 5;
    }

    #collision-flash.flash {
      opacity: 1;
    }

    /* ====== RECORD BUTTON ====== */
    .btn-record {
      padding: 4px 10px;
      background: rgba(255, 60, 60, 0.08);
      border: 1px solid rgba(255, 60, 60, 0.3);
      border-radius: 3px;
      color: #ff5555;
      font-size: 9px;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap;
    }

    .btn-record:hover {
      background: rgba(255, 60, 60, 0.18);
      box-shadow: 0 0 10px rgba(255, 60, 60, 0.25);
    }

    .btn-record.recording {
      background: rgba(255, 60, 60, 0.22);
      border-color: rgba(255, 60, 60, 0.7);
      animation: recpulse 1s ease-in-out infinite;
    }

    @keyframes recpulse {

      0%,
      100% {
        box-shadow: 0 0 6px rgba(255, 60, 60, 0.4);
      }

      50% {
        box-shadow: 0 0 16px rgba(255, 60, 60, 0.8);
      }
    }

    #rec-badge {
      display: none;
      position: absolute;
      top: 10px;
      right: 14px;
      z-index: 20;
      padding: 3px 9px;
      background: rgba(255, 30, 30, 0.85);
      border: 1px solid rgba(255, 80, 80, 0.6);
      border-radius: 3px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      color: #fff;
      letter-spacing: 2px;
      animation: recpulse 1s ease-in-out infinite;
      pointer-events: none;
    }

    #rec-badge.active {
      display: block;
    }

    /* ====== BODY TOOLTIP ====== */
    #body-tooltip {
      position: absolute;
      pointer-events: none;
      z-index: 100;
      background: rgba(2, 8, 30, 0.96);
      border: 1px solid rgba(0, 220, 180, 0.35);
      border-radius: 5px;
      padding: 8px 12px;
      min-width: 160px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9.5px;
      color: var(--text);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.6);
      display: none;
      line-height: 1.7;
    }

    #body-tooltip .tt-name {
      font-family: 'Orbitron', sans-serif;
      font-size: 10px;
      color: var(--teal);
      letter-spacing: 1.5px;
      margin-bottom: 4px;
    }

    #body-tooltip .tt-row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
    }

    #body-tooltip .tt-key {
      color: var(--dim);
    }

    #body-tooltip .tt-val {
      color: var(--bright);
      font-weight: 600;
    }

    /* ====== PRESET DROPDOWN ====== */
    #preset-wrap {
      position: relative;
      flex-shrink: 0;
    }

    #btn-presets {
      padding: 4px 11px;
      background: rgba(255, 215, 0, 0.07);
      border: 1px solid rgba(255, 215, 0, 0.25);
      border-radius: 3px;
      color: var(--gold);
      font-size: 9px;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap;
    }

    #btn-presets:hover {
      background: rgba(255, 215, 0, 0.15);
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
    }

    #preset-menu {
      position: absolute;
      top: calc(100% + 6px);
      right: 0;
      z-index: 300;
      background: rgba(2, 6, 24, 0.99);
      border: 1px solid rgba(255, 215, 0, 0.25);
      border-radius: 5px;
      min-width: 240px;
      display: none;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7);
      overflow: hidden;
    }

    #preset-menu.open {
      display: block;
    }

    .preset-group {
      padding: 5px 12px 3px;
      font-size: 7px;
      letter-spacing: 2px;
      color: rgba(255, 215, 0, 0.45);
      text-transform: uppercase;
      border-bottom: 1px solid rgba(255, 215, 0, 0.08);
      font-family: 'JetBrains Mono', monospace;
    }

    .preset-item {
      padding: 8px 14px;
      display: flex;
      align-items: center;
      gap: 9px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: rgba(200, 220, 255, 0.85);
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 215, 0, 0.04);
      transition: all .1s;
    }

    .preset-item:hover {
      background: rgba(255, 215, 0, 0.07);
      color: var(--gold);
      padding-left: 18px;
    }

    /* ====== CUSTOM SCENARIO EDITOR ====== */
    #editor-panel {
      position: fixed;
      top: 58px;
      right: 380px;
      width: 320px;
      height: calc(100vh - 58px);
      z-index: 200;
      background: rgba(2, 6, 24, 0.98);
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    #editor-panel.open {
      display: flex;
    }

    .ed-hdr {
      padding: 10px 14px;
      background: var(--hl-bg);
      border-bottom: 1px solid rgba(0, 220, 180, 0.15);
      font-family: 'Orbitron', sans-serif;
      font-size: 8px;
      letter-spacing: 3px;
      color: var(--teal);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .ed-close {
      background: none;
      border: none;
      color: var(--dim);
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      padding: 0 4px;
    }

    .ed-close:hover {
      color: var(--nova);
    }

    .ed-body-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .ed-body-card {
      background: rgba(50, 128, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }

    .ed-body-card:hover {
      border-color: rgba(0, 220, 180, 0.3);
    }

    .ed-body-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 8px;
      letter-spacing: 2px;
      color: var(--teal);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .ed-del {
      background: none;
      border: none;
      color: var(--nova);
      cursor: pointer;
      font-size: 13px;
      padding: 0;
    }

    .ed-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 5px;
    }

    .ed-lbl {
      font-size: 8px;
      color: var(--dim);
      width: 34px;
      flex-shrink: 0;
      font-family: 'JetBrains Mono', monospace;
    }

    .ed-inp {
      flex: 1;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border);
      border-radius: 3px;
      color: var(--bright);
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      padding: 3px 6px;
      outline: none;
    }

    .ed-inp:focus {
      border-color: var(--teal);
    }

    .ed-color {
      width: 28px;
      height: 22px;
      border-radius: 3px;
      border: 1px solid var(--border);
      cursor: pointer;
      padding: 0;
    }

    .ed-footer {
      padding: 10px 12px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .ed-btn {
      flex: 1;
      padding: 7px;
      border-radius: 3px;
      border: none;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all .15s;
    }

    .ed-btn-add {
      background: rgba(0, 220, 180, 0.12);
      border: 1px solid rgba(0, 220, 180, 0.3);
      color: var(--teal);
    }

    .ed-btn-add:hover {
      background: rgba(0, 220, 180, 0.22);
    }

    .ed-btn-run {
      background: linear-gradient(135deg, var(--teal), #009070);
      color: #000;
      font-weight: 700;
    }

    .ed-btn-run:hover {
      box-shadow: 0 0 14px rgba(0, 220, 180, 0.4);
    }

    #btn-editor {
      padding: 4px 11px;
      background: rgba(0, 220, 180, 0.07);
      border: 1px solid rgba(0, 220, 180, 0.25);
      border-radius: 3px;
      color: var(--teal);
      font-size: 9px;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap;
    }

    #btn-editor:hover {
      background: rgba(0, 220, 180, 0.15);
    }

    #btn-editor.active {
      background: rgba(0, 220, 180, 0.18);
      border-color: var(--teal);
    }

    /* ====== ENERGY GRAPH ====== */
    #energy-graph-wrap {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(2, 6, 24, 0.88);
      border: 1px solid rgba(0, 220, 180, 0.18);
      border-radius: 4px;
      padding: 6px 8px;
      display: none;
    }

    #energy-graph-wrap.visible {
      display: block;
    }

    .eg-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 7px;
      color: rgba(0, 220, 180, 0.6);
      letter-spacing: 2px;
      margin-bottom: 4px;
    }

    #energy-canvas {
      display: block;
    }

    /* ====== KEYBOARD SHORTCUT HINT ====== */
    #kb-hint {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 10;
      font-family: 'JetBrains Mono', monospace;
      font-size: 7.5px;
      color: rgba(120, 160, 200, 0.35);
      pointer-events: none;
      text-align: right;
      line-height: 1.8;
    }
  </style>
</head>

<body>
  <canvas id="stars"></canvas>

  <div class="app">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER RIBBON ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <header>
      <div class="logo">
        <div class="logo-ring">‚öõ</div>
        <div>
          <div class="logo-name">ASTRO THESAURUS</div>
          <div class="logo-sub">Where Gravity Tells Its Story</div>
        </div>
      </div>

      <!-- Quick Simulate search -->
      <div class="sim-bar">
        <span class="sim-bar-tag">Quick Simulate</span>
        <div class="sim-bar-wrap">
          <input id="sim-input" type="text" placeholder="Describe any gravitational system‚Ä¶" autocomplete="off">
          <button id="sim-go">‚ñ∂</button>
          <div id="sim-sugg">
            <div class="sugg-head">Suggestions</div>
            <div class="sugg-item" data-val="Jupiter‚ÄìMoon System ‚Äî Io, Europa, Ganymede, Callisto">
              <span class="sugg-ic">ü™ê</span>Jupiter‚ÄìMoon System
            </div>
            <div class="sugg-item" data-val="Binary Star Orbit ‚Äî two equal-mass stars">
              <span class="sugg-ic">‚≠ê</span>Binary Star Orbit
            </div>
            <div class="sugg-item" data-val="Asteroid Belt around a Sun-like star">
              <span class="sugg-ic">üåë</span>Asteroid Belt Density
            </div>
          </div>
        </div>
      </div>

      <div id="preset-wrap">
        <button id="btn-presets">‚òÖ Presets</button>
        <div id="preset-menu"></div>
      </div>
      <button id="btn-editor">‚úè Editor</button>
      <div class="hstats">
        <div class="hs"><span class="hs-l">Scenario</span><span class="hs-v" id="hs-sc">‚Äî</span></div>
        <div class="hs"><span class="hs-l">Bodies</span><span class="hs-v" id="hs-bd">0</span></div>
        <div class="hs"><span class="hs-l">Time</span><span class="hs-v" id="hs-t">0.000</span></div>
        <div class="hs"><span class="hs-l">FPS</span><span class="hs-v" id="hs-fps">‚Äî</span></div>
        <div class="pill">
          <div class="dot"></div><span class="pill-t">REBOUND</span>
        </div>
      </div>
    </header>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CENTER ‚Äî SIMULATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="center">

      <!-- Section header: LIVE SIMULATION / ORBITAL PLOT tabs + energy -->
      <div class="sec-hdr" id="view-hdr">
        <div class="vtab-group">
          <button class="vtab active" id="vt-sim" onclick="setView('sim')">
            ‚ñ∂ LIVE SIMULATION
          </button>
          <button class="vtab gold-tab" id="vt-plot" onclick="setView('plot')">
            ‚óà ORBITAL PLOT
          </button>
        </div>
        <div class="sec-hdr-sp"></div>
        <div id="energy-badge" class="sec-hdr-badge">ŒîE/E: ‚Äî</div>
      </div>

      <!-- Simulation options bar -->
      <div id="sim-opts">
        <button class="btn on" id="btn-pause">‚è∏ Pause</button>
        <button class="btn red" id="btn-reset">‚Ü∫ Reset</button>
        <div class="opts-sep"></div>
        <button class="btn on" id="btn-trail">‚óé Trails</button>
        <button class="btn on" id="btn-glow">‚ú¶ Glow</button>
        <button class="btn on" id="btn-lbl">‚åñ Labels</button>
        <button class="btn" id="btn-elems">‚äô Elements</button>
        <div class="opts-sep"></div>
        <button class="btn-nasa" id="btn-nasa"
          title="Load today&#39;s real planetary positions from NASA JPL Horizons">üõ∞ NASA Live</button>
        <button class="btn-screenshot" id="btn-screenshot" title="Save canvas as PNG">üì∑ Screenshot</button>
        <button class="btn-record" id="btn-record" title="Record simulation as WebM video">üî¥ Record</button>
        <div class="opts-sep"></div>
        <div class="sl-inline">
          <span class="sl-lbl-s">Speed</span>
          <input type="range" id="spd-sl" min="1" max="16" value="1">
          <span class="sl-val" id="spd-v">1√ó</span>
        </div>
        <div class="sl-inline" style="margin-left:6px">
          <span class="sl-lbl-s">Trail</span>
          <input type="range" id="trl-sl" min="1" max="10" value="4">
          <span class="sl-val" id="trl-v">Med</span>
        </div>
      </div>

      <!-- Status bar ‚Äî z-index:10, high contrast, no opacity tricks -->
      <div id="status-bar">
        <div id="status-dot"></div>
        <span id="status-txt">Ready - Enter a simulation prompt above or ask the AI assistant</span>
      </div>

      <!-- Canvas -->
      <div id="canvas-wrap">
        <canvas id="sim-canvas"></canvas>
        <div id="collision-flash"></div>
        <div id="rec-badge">‚óè REC</div>
        <div class="cv-corner tl"></div>
        <div class="cv-corner tr"></div>
        <div class="cv-corner bl"></div>
        <div class="cv-corner br"></div>
        <div class="cv-hud" id="hud-tl">
          <div>Astro Thesaurus // REBOUND v4</div>
          <div id="hud-sc">Awaiting simulation</div>
        </div>
        <div class="cv-hud" id="hud-tr">
          <div id="hud-info">Enter a prompt above</div>
          <div id="hud-int"></div>
        </div>
        <div class="cv-hud" id="hud-bl">
          <div id="hud-desc"></div>
        </div>
        <div id="body-tooltip"></div>
        <div id="energy-graph-wrap">
          <div class="eg-title">ENERGY DRIFT</div>
          <canvas id="energy-canvas" width="180" height="50"></canvas>
        </div>
        <div id="kb-hint">SPACE pause ‚ÄÉ R reset ‚ÄÉ S screenshot ‚ÄÉ T trails ‚ÄÉ G glow ‚ÄÉ E elements</div>
        <div id="watermark">REBOUND</div>
        <div id="empty-state">
          <div class="es-title">Live Simulation</div>
          <div class="es-divider"></div>
          <div class="es-txt">Type any gravitational system above<br>REBOUND simulates it live in real-time</div>
        </div>
      </div>

      <!-- Plot view -->
      <div id="plot-wrap">
        <div id="plot-empty">
          <div class="pe-title">Orbital Plot</div>
          <div class="pe-divider"></div>
          <div class="pe-txt">Ask the AI assistant to generate<br>an orbital plot for any body or system</div>
        </div>
        <img id="plot-img" alt="Orbital Plot">
      </div>

    </div><!-- #center -->

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RIGHT ‚Äî AI ASSISTANT (full height) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="right">

      <!-- Section header: AI ASSISTANT ‚Äî dark highlight -->
      <div class="sec-hdr" style="height:58px; border-top:none;">
        <div class="sec-hdr-title">
          <span class="sec-hdr-dot"></span>
          AI ORBITAL ASSISTANT
        </div>
        <div class="sec-hdr-sp"></div>
        <span class="sec-hdr-badge">RAG ¬∑ Llama 3.1</span>
      </div>

      <div id="chat-msgs">
        <div class="welcome">
          <div class="wc-title">REBOUND + RAG Active</div>
          <div class="wc-body">Ask anything in plain English. Simulation prompts auto-launch in the viewer.</div>
          <div class="wc-exs">
            <div class="wce" onclick="fillChat('What is a Hohmann transfer?')">‚Üí What is a Hohmann transfer?</div>
            <div class="wce" onclick="fillChat('Explain Lagrange points')">‚Üí Explain Lagrange points</div>
            <div class="wce" onclick="fillChat('Show Mars orbit for 2 years')">‚Üí Show Mars orbit plot</div>
            <div class="wce" onclick="fillSim('TRAPPIST-1 all 7 planets')">‚ö° Simulate TRAPPIST-1</div>
            <div class="wce" onclick="fillSim('Earth Moon system')">‚ö° Simulate Earth-Moon</div>
            <div class="wce" onclick="fillSim('Hot Jupiter with two planets')">‚ö° Simulate Hot Jupiter</div>
          </div>
        </div>
      </div>

      <div id="input-area">
        <!-- System status ‚Äî always visible above input -->
        <div class="api-row">
          <div class="api-dot wait" id="api-dot"></div>
          <span class="api-lbl" id="api-lbl">Checking connection‚Ä¶</span>
        </div>
        <div class="inp-row">
          <textarea id="chat-in" placeholder="Ask about orbital mechanics, Kepler's laws, exoplanets‚Ä¶"
            rows="2"></textarea>
          <button id="send">‚û§</button>
        </div>
      </div>

    </div><!-- #right -->

    <!-- CUSTOM SCENARIO EDITOR PANEL -->
    <div id="editor-panel">
      <div class="ed-hdr">
        <span>‚úè SCENARIO EDITOR</span>
        <button class="ed-close" id="ed-close">√ó</button>
      </div>
      <div class="ed-body-list" id="ed-body-list"></div>
      <div class="ed-footer">
        <button class="ed-btn ed-btn-add" id="ed-add">‚äï Add Body</button>
        <button class="ed-btn ed-btn-run" id="ed-run">‚ñ∂ Launch</button>
      </div>
    </div>

  </div><!-- .app -->

  <script>
    'use strict';

    var API = 'http://localhost:8000';
    var WS_URL = 'ws://localhost:8000/ws/sim';

    var ws = null;
    var simState = {
      playing: true, showTrails: true, showGlow: true, showLabels: true,
      trailAlpha: 0.12, speedMult: 1, currentBodies: [], scale: 180, scenarioName: '',
      trails: []   // BUG FIX: was referenced in Reset handler but never declared
    };
    var fpsCount = 0, fpsLast = Date.now(), fps = 0, currentView = 'sim';

    // ‚îÄ‚îÄ STARFIELD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    (function () {
      var c = document.getElementById('stars'), ctx = c.getContext('2d'), stars = [], shooters = [];
      function rs() { c.width = innerWidth; c.height = innerHeight; }
      function init() {
        stars = [];
        for (var i = 0; i < 500; i++) stars.push({ x: Math.random() * c.width, y: Math.random() * c.height, r: Math.random() * 1.4 + 0.1, a: Math.random() * Math.PI * 2, s: Math.random() * 0.35 + 0.015, h: Math.random() * 80 + 190, bright: i < 40 });
      }
      function draw() {
        ctx.clearRect(0, 0, c.width, c.height);
        stars.forEach(function (s) {
          s.a += s.s * 0.01;
          var al = ((Math.sin(s.a) + 1) / 2) * 0.75 + 0.05;
          ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
          ctx.fillStyle = 'hsla(' + s.h + ',50%,90%,' + al + ')'; ctx.fill();
        });
        // Shooting stars
        if (Math.random() < 0.003) shooters.push({ x: Math.random() * c.width * .7, y: Math.random() * c.height * .5, vx: Math.random() * 7 + 3, vy: Math.random() * 3 + 1.5, life: 1, len: Math.random() * 70 + 30 });
        shooters = shooters.filter(function (s) {
          s.x += s.vx; s.y += s.vy; s.life -= 0.028;
          if (s.life <= 0) return false;
          ctx.strokeStyle = 'rgba(200,220,255,' + s.life * 0.65 + ')'; ctx.lineWidth = 1;
          ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(s.x - s.vx * s.len / 10, s.y - s.vy * s.len / 10); ctx.stroke();
          return true;
        });
        requestAnimationFrame(draw);
      }
      rs(); init(); draw();
      window.addEventListener('resize', function () { rs(); init(); });
    })();

    // ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var canvas = document.getElementById('sim-canvas'), ctx = canvas.getContext('2d');
    function resizeCanvas() {
      var w = document.getElementById('canvas-wrap');
      canvas.width = w.offsetWidth; canvas.height = w.offsetHeight;
    }

    // ‚îÄ‚îÄ VIEW TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setView(v) {
      currentView = v;
      document.getElementById('vt-sim').className = v === 'sim' ? 'vtab active' : 'vtab';
      document.getElementById('vt-plot').className = v === 'plot' ? 'vtab gold-tab active' : 'vtab gold-tab';
      document.getElementById('canvas-wrap').style.display = v === 'sim' ? 'block' : 'none';
      document.getElementById('plot-wrap').style.display = v === 'plot' ? 'flex' : 'none';
      var hdr = document.getElementById('view-hdr');
      hdr.className = v === 'plot' ? 'sec-hdr gold' : 'sec-hdr';
      // update status text only when no sim is running
      if (!simState.scenarioName) {
        var txt = v === 'plot'
          ? 'Ready - Ask the AI assistant to generate an orbital plot'
          : 'Ready - Enter a simulation prompt above or ask the AI assistant';
        document.getElementById('status-txt').textContent = txt;
      }
    }

    // ‚îÄ‚îÄ SUGGESTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var simInput = document.getElementById('sim-input');
    var suggBox = document.getElementById('sim-sugg');
    simInput.addEventListener('focus', function () { if (!this.value) suggBox.classList.add('open'); });
    simInput.addEventListener('blur', function () { setTimeout(function () { suggBox.classList.remove('open'); }, 200); });
    simInput.addEventListener('input', function () { suggBox.classList.toggle('open', this.value.length === 0); });
    document.querySelectorAll('.sugg-item').forEach(function (el) {
      el.addEventListener('mousedown', function (e) {
        e.preventDefault();
        simInput.value = this.getAttribute('data-val');
        suggBox.classList.remove('open');
        startSim(simInput.value);
      });
    });

    // ‚îÄ‚îÄ WEBSOCKET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function connectWS(onOpen) {
      if (ws && ws.readyState < 2) { ws.close(); }
      setStatus('spin', 'Connecting to REBOUND server‚Ä¶');
      ws = new WebSocket(WS_URL);
      ws.onopen = function () { setStatus('ok', 'Connected to REBOUND'); if (onOpen) onOpen(); };
      ws.onmessage = function (e) { handleWsMessage(JSON.parse(e.data)); };
      ws.onerror = function () { setStatus('err', 'WebSocket error ‚Äî is websocket_server.py running?'); };
      ws.onclose = function () { setStatus('err', 'Disconnected from server'); };
    }
    function wsSend(obj) { if (ws && ws.readyState === 1) ws.send(JSON.stringify(obj)); }

    function handleWsMessage(msg) {
      if (msg.type === 'status') { setStatus('spin', msg.message); }
      else if (msg.type === 'error') { setStatus('err', msg.message); addMsg('err', msg.message, null); }
      else if (msg.type === 'scenario') {
        var d = msg.data;
        simState.scale = d.scale || 180; simState.scenarioName = d.name || '?';
        document.getElementById('hs-sc').textContent = (d.name || '?').slice(0, 12).toUpperCase();
        document.getElementById('hs-bd').textContent = d.N || '?';
        document.getElementById('hud-sc').textContent = (d.name || '').toUpperCase();
        document.getElementById('hud-info').textContent = d.N + ' BODIES';
        document.getElementById('hud-int').textContent = 'INTEGRATOR: ' + (d.integrator || '').toUpperCase();
        document.getElementById('hud-desc').textContent = d.description || '';
        document.getElementById('watermark').textContent = (d.name || '').toUpperCase();
        document.getElementById('empty-state').style.display = 'none';
        setStatus('ok', 'Running: ' + d.name + (msg.source === 'ai' ? ' (AI-generated)' : ''));
        setView('sim'); simState.playing = true;
        addMsg('sys', (msg.source === 'ai' ? '‚ö° AI: ' : '‚úì ') + d.name + ' ‚Äî ' + d.N + ' bodies, ' + (d.integrator || '').toUpperCase(), null);
      }
      else if (msg.type === 'frame') {
        renderFrame(msg.data);
        if (msg.data.collision) {
          triggerCollisionFlash();
          addMsg('sys', 'üí• Collision! Bodies merged ‚Äî ' + msg.data.N + ' remaining', null);
        }
        fpsCount++;
        var now = Date.now();
        if (now - fpsLast >= 1000) { fps = fpsCount; fpsCount = 0; fpsLast = now; document.getElementById('hs-fps').textContent = fps; }
      }
      else if (msg.type === 'elements') { showElements(msg.data); }
    }

    // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var TYPE_GLOW = { star: 3.5, giant: 4.5, blackhole: 7, neutron: 6, dwarf: 3, planet: 2.8, debris: 1.5, asteroid: 1.5, moon: 2.5, comet: 4, spacecraft: 2 };
    function hexRgb(h) {
      h = h.replace('#', ''); if (h.length === 3) h = h[0] + h[0] + h[1] + h[1] + h[2] + h[2];
      return parseInt(h.slice(0, 2), 16) + ',' + parseInt(h.slice(2, 4), 16) + ',' + parseInt(h.slice(4, 6), 16);
    }

    function renderFrame(data) {
      var W = canvas.width, H = canvas.height, cx = W / 2, cy = H / 2, scale = simState.scale;
      ctx.fillStyle = simState.showTrails ? 'rgba(0,0,10,' + simState.trailAlpha + ')' : '#000010';
      ctx.fillRect(0, 0, W, H);
      document.getElementById('hs-t').textContent = (data.t || 0).toFixed(3);
      var dE = data.energy_drift || 0;
      var eb = document.getElementById('energy-badge');
      eb.textContent = 'ŒîE/E: ' + dE.toExponential(1);
      eb.style.color = dE < 1e-6 ? '#00ff88' : dE < 1e-3 ? '#ffcc44' : '#ff4444';
      var bodies = data.bodies || []; simState.currentBodies = bodies;

      // Z-ORDER FIX: Render stars first (background), then planets by distance
      var sortedBodies = bodies.slice().sort(function (a, b) {
        // Stars always in back
        if (a.type === 'star' && b.type !== 'star') return -1;
        if (b.type === 'star' && a.type !== 'star') return 1;
        // Render farther bodies first (they go behind)
        var distA = a.x * a.x + a.y * a.y;
        var distB = b.x * b.x + b.y * b.y;
        return distB - distA;
      });

      sortedBodies.forEach(function (b) {
        var px = cx + b.x * scale, py = cy + b.y * scale, r = b.radius || 5;
        var rgb = hexRgb(b.color || '#ffffff'), gm = TYPE_GLOW[b.type] || 3;
        if (simState.showGlow) {
          var g1 = ctx.createRadialGradient(px, py, 0, px, py, r * gm * 3);
          g1.addColorStop(0, 'rgba(' + rgb + ',0.10)'); g1.addColorStop(1, 'rgba(' + rgb + ',0)');
          ctx.beginPath(); ctx.arc(px, py, r * gm * 3, 0, Math.PI * 2); ctx.fillStyle = g1; ctx.fill();
          var g2 = ctx.createRadialGradient(px, py, 0, px, py, r * gm);
          g2.addColorStop(0, 'rgba(' + rgb + ',0.60)'); g2.addColorStop(0.5, 'rgba(' + rgb + ',0.18)'); g2.addColorStop(1, 'rgba(' + rgb + ',0)');
          ctx.beginPath(); ctx.arc(px, py, r * gm, 0, Math.PI * 2); ctx.fillStyle = g2; ctx.fill();
        }
        ctx.beginPath(); ctx.arc(px, py, r, 0, Math.PI * 2); ctx.fillStyle = b.color || '#ffffff'; ctx.fill();
        if (r > 4 && simState.showGlow) {
          var gs = ctx.createRadialGradient(px - r * .3, py - r * .3, 0, px, py, r);
          gs.addColorStop(0, 'rgba(255,255,255,0.38)'); gs.addColorStop(0.5, 'rgba(255,255,255,0.08)'); gs.addColorStop(1, 'rgba(255,255,255,0)');
          ctx.beginPath(); ctx.arc(px, py, r, 0, Math.PI * 2); ctx.fillStyle = gs; ctx.fill();
        }
        if (b.type === 'blackhole') {
          [1.8, 2.5, 3.4].forEach(function (m, i) {
            ctx.beginPath(); ctx.arc(px, py, r * m, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(' + rgb + ',' + (0.44 - i * 0.12) + ')'; ctx.lineWidth = 1.5 - i * 0.35; ctx.stroke();
          });
        }
        if (simState.showLabels && bodies.length <= 24) {
          ctx.font = '500 8.5px "Space Grotesk",sans-serif';
          ctx.fillStyle = 'rgba(180,210,255,0.6)';
          ctx.fillText(b.name, px + r + 4, py + 3);
        }
      });
    }

    // ‚îÄ‚îÄ SIM CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function startSim(prompt) {
      var go = document.getElementById('sim-go');
      go.disabled = true; go.textContent = '‚è≥';
      setStatus('spin', 'Requesting: ' + prompt);
      connectWS(function () {
        wsSend({ action: 'start', prompt: prompt, fps: 30, steps_per_frame: simState.speedMult });
        go.disabled = false; go.textContent = '‚ñ∂';
      });
    }

    document.getElementById('sim-go').addEventListener('click', function () {
      var p = simInput.value.trim(); if (p) startSim(p);
    });
    simInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') { suggBox.classList.remove('open'); var p = this.value.trim(); if (p) startSim(p); }
    });

    document.getElementById('btn-pause').addEventListener('click', function () {
      simState.playing = !simState.playing;
      wsSend({ action: simState.playing ? 'resume' : 'pause' });
      this.textContent = simState.playing ? '‚è∏ Pause' : '‚ñ∂ Play';
      this.className = simState.playing ? 'btn on' : 'btn';
    });
    document.getElementById('btn-reset').addEventListener('click', function () {
      wsSend({ action: 'reset' });
      simState.trails = [];   // BUG FIX: was iterating undefined array
      simState.playing = false;
      var pauseBtn = document.getElementById('btn-pause');
      pauseBtn.textContent = '‚ñ∂ Play';
      pauseBtn.className = 'btn';
      ctx.fillStyle = '#000010';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    });
    document.getElementById('btn-trail').addEventListener('click', function () { simState.showTrails = !simState.showTrails; this.className = simState.showTrails ? 'btn on' : 'btn'; });
    document.getElementById('btn-glow').addEventListener('click', function () { simState.showGlow = !simState.showGlow; this.className = simState.showGlow ? 'btn on' : 'btn'; });
    document.getElementById('btn-lbl').addEventListener('click', function () { simState.showLabels = !simState.showLabels; this.className = simState.showLabels ? 'btn on' : 'btn'; });
    document.getElementById('btn-elems').addEventListener('click', function () { wsSend({ action: 'get_elements' }); });
    document.getElementById('spd-sl').addEventListener('input', function () {
      simState.speedMult = parseInt(this.value);
      document.getElementById('spd-v').textContent = simState.speedMult + '√ó';
      wsSend({ action: 'set_speed', multiplier: simState.speedMult });
    });
    document.getElementById('trl-sl').addEventListener('input', function () {
      var v = parseInt(this.value);
      var labels = ['', 'V.Long', 'Long', 'Long', 'Med', 'Med', 'Short', 'Short', 'Fast', 'V.Fast', 'Inst'];
      simState.trailAlpha = v * 0.025 + 0.015;
      document.getElementById('trl-v').textContent = labels[v];
    });

    // ‚îÄ‚îÄ ELEMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showElements(elements) {
      if (!elements || !elements.length) return;
      var div = document.createElement('div');
      div.className = 'msg msg-a';
      div.innerHTML = '<div class="msg-a-tag">Orbital Elements</div>';
      var tbl = document.createElement('table'); tbl.className = 'dtable';
      var hdr = document.createElement('tr');
      hdr.innerHTML = '<td><b>Body</b></td><td><b>a (AU)</b></td><td><b>e</b></td><td><b>P (yr)</b></td><td><b>inc (¬∞)</b></td>';
      tbl.appendChild(hdr);
      elements.forEach(function (el) {
        if (el.error) return;
        var tr = document.createElement('tr');
        tr.innerHTML = '<td>' + el.name + '</td>'
          + '<td>' + (el.a !== undefined ? el.a.toFixed(4) : '‚Äî') + '</td>'
          + '<td>' + (el.e !== undefined ? el.e.toFixed(4) : '‚Äî') + '</td>'
          + '<td>' + (el.P !== undefined ? el.P.toFixed(4) : '‚Äî') + '</td>'
          + '<td>' + (el.inc !== undefined ? el.inc.toFixed(2) : '‚Äî') + '</td>';
        tbl.appendChild(tr);
      });
      div.appendChild(tbl);
      var msgs = document.getElementById('chat-msgs');
      msgs.appendChild(div); msgs.scrollTop = msgs.scrollHeight;
    }

    // ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setStatus(state, msg) {
      var dot = document.getElementById('status-dot');
      dot.className = ''; dot.classList.add(state);
      document.getElementById('status-txt').textContent = msg;
    }

    // ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function fillChat(t) { document.getElementById('chat-in').value = t; document.getElementById('chat-in').focus(); }
    function fillSim(t) { simInput.value = t; startSim(t); }

    function checkAPI() {
      fetch(API + '/api/health')
        .then(function (r) { return r.json(); })
        .then(function (d) {
          document.getElementById('api-dot').className = 'api-dot on';
          document.getElementById('api-lbl').textContent = 'REBOUND ' + d.rebound + '  ¬∑  RAG ' + d.rag_docs + ' docs  ¬∑  Online';
        })
        .catch(function () {
          document.getElementById('api-dot').className = 'api-dot off';
          document.getElementById('api-lbl').textContent = 'API Offline ‚Äî run websocket_server.py';
        });
    }

    // addMsg(type, content, simPrompt)
    // simPrompt: string ‚Üí adds replay button; null ‚Üí no replay button
    function addMsg(type, content, simPrompt) {
      var msgs = document.getElementById('chat-msgs');
      var div = document.createElement('div');
      if (type === 'u') {
        div.className = 'msg msg-u'; div.textContent = content;
      } else if (type === 'sys') {
        div.className = 'msg msg-sys'; div.textContent = content;
      } else if (type === 'err') {
        div.className = 'msg msg-err'; div.textContent = content;
      } else {
        div.className = 'msg msg-a';
        div.innerHTML = '<div class="msg-a-tag">AI ¬∑ Llama 3.1</div>';
        var p = document.createElement('p'); p.textContent = content.text || ''; div.appendChild(p);
        if (content.data) {
          var tbl = document.createElement('table'); tbl.className = 'dtable';
          Object.entries(content.data).forEach(function (kv) {
            if (typeof kv[1] === 'object') return;
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + String(kv[0]).replace(/_/g, ' ') + '</td><td>' + kv[1] + '</td>';
            tbl.appendChild(tr);
          });
          div.appendChild(tbl);
        }
        if (content.plot) {
          var img = document.createElement('img'); img.className = 'chat-plot';
          img.src = 'data:image/png;base64,' + content.plot;
          img.addEventListener('click', function () {
            var pi = document.getElementById('plot-img');
            pi.src = img.src; pi.style.display = 'block';
            document.getElementById('plot-empty').style.display = 'none';
            setView('plot');
          });
          div.appendChild(img);
        }
        // ‚îÄ‚îÄ REPLAY BUTTON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (simPrompt) {
          var rb = document.createElement('button');
          rb.className = 'btn-replay';
          var label = simPrompt.length > 36 ? simPrompt.slice(0, 36) + '‚Ä¶' : simPrompt;
          rb.innerHTML = '<span class="btn-replay-icon">‚Ü∫</span> Replay: ' + label;
          (function (sp) { rb.addEventListener('click', function () { startSim(sp); addMsg('sys', '‚Ü∫ Replaying: ' + sp, null); }); })(simPrompt);
          div.appendChild(rb);
        }
      }
      msgs.appendChild(div);
      msgs.scrollTop = msgs.scrollHeight;
    }

    function addTyping() {
      var msgs = document.getElementById('chat-msgs');
      var d = document.createElement('div'); d.className = 'msg msg-a typing'; d.id = 'typing';
      d.innerHTML = '<span></span><span></span><span></span>';
      msgs.appendChild(d); msgs.scrollTop = msgs.scrollHeight;
    }
    function removeTyping() { var t = document.getElementById('typing'); if (t) t.remove(); }

    function sendMsg() {
      var inp = document.getElementById('chat-in');
      var msg = inp.value.trim(); if (!msg) return;
      addMsg('u', msg, null); inp.value = '';
      document.getElementById('send').disabled = true; addTyping();
      fetch(API + '/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: msg }) })
        .then(function (r) { return r.json(); })
        .then(function (data) {
          removeTyping();
          // pass sim_prompt so replay button appears when AI suggested a simulation
          addMsg('a', { text: data.text, data: data.data, plot: data.plot }, data.sim_prompt || null);
          if (data.plot) {
            var pi = document.getElementById('plot-img');
            pi.src = 'data:image/png;base64,' + data.plot; pi.style.display = 'block';
            document.getElementById('plot-empty').style.display = 'none'; setView('plot');
          }
          if (data.sim_prompt) {
            simInput.value = data.sim_prompt;
            addMsg('sys', '‚ö° Auto-launching simulation‚Ä¶', null);
            setTimeout(function () { startSim(data.sim_prompt); }, 500);
          }
          document.getElementById('send').disabled = false;
        })
        .catch(function () {
          removeTyping(); addMsg('err', 'Connection failed ‚Äî is the server running?', null);
          document.getElementById('send').disabled = false;
        });
    }

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.addEventListener('load', function () {
      resizeCanvas(); checkAPI(); setInterval(checkAPI, 30000);
      document.getElementById('send').addEventListener('click', sendMsg);
      document.getElementById('chat-in').addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
      });
      window.addEventListener('resize', function () {
        resizeCanvas(); ctx.fillStyle = '#000010'; ctx.fillRect(0, 0, canvas.width, canvas.height);
      });
    });

    // == COLLISION FLASH ==
    function triggerCollisionFlash() {
      var el = document.getElementById('collision-flash');
      el.classList.add('flash');
      setTimeout(function () { el.classList.remove('flash'); }, 400);
    }

    // == SCREENSHOT ==
    document.getElementById('btn-screenshot').addEventListener('click', function () {
      var out = document.createElement('canvas');
      out.width = canvas.width; out.height = canvas.height;
      var octx = out.getContext('2d');
      octx.fillStyle = '#000010';
      octx.fillRect(0, 0, out.width, out.height);
      octx.drawImage(canvas, 0, 0);
      octx.font = '700 11px "JetBrains Mono", monospace';
      octx.fillStyle = 'rgba(0,220,180,0.45)';
      octx.fillText('ASTRO THESAURUS  //  REBOUND', 14, out.height - 12);
      var ts = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
      var name = (simState.scenarioName || 'astro').toLowerCase().replace(/[^a-z0-9]+/g, '-');
      var link = document.createElement('a');
      link.download = 'astro-' + name + '-' + ts + '.png';
      link.href = out.toDataURL('image/png');
      link.click();
    });

    // == NASA HORIZONS ==
    document.getElementById('btn-nasa').addEventListener('click', function () {
      var btn = this;
      btn.disabled = true; btn.textContent = '‚è≥ Fetching‚Ä¶';
      setStatus('spin', 'Loading live NASA JPL Horizons data‚Ä¶');
      fetch(API + '/api/horizons')
        .then(function (r) { return r.json(); })
        .then(function (data) {
          btn.disabled = false; btn.textContent = 'üõ∞ NASA Live';
          if (!data.ok) { setStatus('err', 'NASA error: ' + (data.error || '')); return; }
          connectWS(function () {
            wsSend({ action: 'start', prompt: data.scenario.name, fps: 30, steps_per_frame: 2 });
          });
          addMsg('sys', 'üõ∞ Live NASA Horizons loaded ‚Äî real planetary positions for today', null);
        })
        .catch(function () {
          btn.disabled = false; btn.textContent = 'üõ∞ NASA Live';
          setStatus('err', 'Could not reach server');
        });
    });

    // == VIDEO EXPORT (MediaRecorder API - no libraries needed) ==
    (function () {
      var mediaRecorder = null;
      var recordedChunks = [];
      var isRecording = false;
      var recordBtn = null;
      var recBadge = null;

      window.addEventListener('load', function () {
        recordBtn = document.getElementById('btn-record');
        recBadge = document.getElementById('rec-badge');

        // Check browser support
        if (!window.MediaRecorder) {
          recordBtn.title = 'Video recording not supported in this browser';
          recordBtn.style.opacity = '0.35';
          recordBtn.style.cursor = 'not-allowed';
          return;
        }

        recordBtn.addEventListener('click', function () {
          if (!isRecording) {
            startRecording();
          } else {
            stopRecording();
          }
        });
      });

      function startRecording() {
        recordedChunks = [];

        // Capture the sim canvas stream at 30fps
        var stream = canvas.captureStream(30);

        // Pick best supported format
        var mimeType = '';
        var ext = 'webm';
        if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
          mimeType = 'video/webm;codecs=vp9';
        } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
          mimeType = 'video/webm;codecs=vp8';
        } else if (MediaRecorder.isTypeSupported('video/webm')) {
          mimeType = 'video/webm';
        } else if (MediaRecorder.isTypeSupported('video/mp4')) {
          mimeType = 'video/mp4'; ext = 'mp4';
        }

        var options = mimeType ? { mimeType: mimeType, videoBitsPerSecond: 4000000 } : {};

        try {
          mediaRecorder = new MediaRecorder(stream, options);
        } catch (e) {
          addMsg('err', 'Recording failed: ' + e.message, null);
          return;
        }

        mediaRecorder.ondataavailable = function (e) {
          if (e.data && e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = function () {
          var blob = new Blob(recordedChunks, { type: mimeType || 'video/webm' });
          var url = URL.createObjectURL(blob);
          var ts = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
          var name = (simState.scenarioName || 'astro').toLowerCase().replace(/[^a-z0-9]+/g, '-');
          var link = document.createElement('a');
          link.download = 'astro-' + name + '-' + ts + '.' + ext;
          link.href = url;
          link.click();
          setTimeout(function () { URL.revokeObjectURL(url); }, 5000);
          var sizeMB = (blob.size / 1048576).toFixed(1);
          addMsg('sys', 'üé¨ Recording saved ‚Äî ' + sizeMB + ' MB  (' + ext.toUpperCase() + ')', null);
        };

        mediaRecorder.start(100); // collect data every 100ms
        isRecording = true;
        recordBtn.textContent = '‚èπ Stop';
        recordBtn.classList.add('recording');
        recBadge.classList.add('active');
        addMsg('sys', 'üî¥ Recording started ‚Äî click Stop to save', null);
      }

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
        }
        isRecording = false;
        recordBtn.textContent = 'üî¥ Record';
        recordBtn.classList.remove('recording');
        recBadge.classList.remove('active');
      }
    })();

    // ================================================================
    // FEATURE: SPEED-COLORED TRAILS
    // Store last 80 positions per body with speed for color mapping
    // ================================================================
    var trailStore = {};   // { bodyName: [{x,y,speed}, ...] }
    var TRAIL_LEN = 80;
    var trailColorMode = false;  // toggle: false = body color, true = speed heatmap

    function speedToColor(speed, maxSpeed) {
      // Map 0..1 (normalised speed) to blue->cyan->green->yellow->red
      var t = Math.min(speed / (maxSpeed || 1), 1);
      var r, g, b;
      if (t < 0.25) { r = 0; g = Math.round(t * 4 * 255); b = 255; }
      else if (t < 0.5) { r = 0; g = 255; b = Math.round((1 - (t - 0.25) * 4) * 255); }
      else if (t < 0.75) { r = Math.round((t - 0.5) * 4 * 255); g = 255; b = 0; }
      else { r = 255; g = Math.round((1 - (t - 0.75) * 4) * 255); b = 0; }
      return 'rgb(' + r + ',' + g + ',' + b + ')';
    }

    function updateTrailStore(bodies) {
      var maxSpeed = 0;
      bodies.forEach(function (b) {
        var spd = Math.sqrt((b.vx || 0) * (b.vx || 0) + (b.vy || 0) * (b.vy || 0));
        if (spd > maxSpeed) maxSpeed = spd;
      });
      bodies.forEach(function (b) {
        var key = b.name || b.color;
        if (!trailStore[key]) trailStore[key] = [];
        var spd = Math.sqrt((b.vx || 0) * (b.vx || 0) + (b.vy || 0) * (b.vy || 0));
        trailStore[key].push({ x: b.x, y: b.y, speed: spd, maxSpeed: maxSpeed, color: b.color });
        if (trailStore[key].length > TRAIL_LEN) trailStore[key].shift();
      });
    }

    function drawSpeedTrails(W, H) {
      var cx = W / 2, cy = H / 2, scale = simState.scale;
      Object.keys(trailStore).forEach(function (key) {
        var pts = trailStore[key];
        if (pts.length < 2) return;
        var maxSpd = pts[pts.length - 1].maxSpeed || 1;
        for (var i = 1; i < pts.length; i++) {
          var alpha = (i / pts.length) * 0.75;
          var col = trailColorMode
            ? speedToColor(pts[i].speed, maxSpd)
            : (pts[i].color || '#ffffff');
          ctx.beginPath();
          ctx.moveTo(cx + pts[i - 1].x * scale, cy + pts[i - 1].y * scale);
          ctx.lineTo(cx + pts[i].x * scale, cy + pts[i].y * scale);
          ctx.strokeStyle = col.startsWith('rgb(')
            ? col.replace('rgb(', 'rgba(').replace(')', ',' + alpha + ')')
            : col;
          ctx.lineWidth = 1.5;
          ctx.globalAlpha = alpha;
          ctx.stroke();
          ctx.globalAlpha = 1;
        }
      });
    }

    // ================================================================
    // FEATURE: ENERGY / DRIFT GRAPH
    // ================================================================
    var energyHistory = [];
    var MAX_ENERGY_PTS = 180;
    var egCanvas = null, egCtx = null;
    var showEnergyGraph = false;

    function initEnergyGraph() {
      egCanvas = document.getElementById('energy-canvas');
      egCtx = egCanvas.getContext('2d');
    }

    function updateEnergyGraph(drift) {
      energyHistory.push(drift);
      if (energyHistory.length > MAX_ENERGY_PTS) energyHistory.shift();
      if (!showEnergyGraph || !egCtx) return;
      var W = egCanvas.width, H = egCanvas.height;
      egCtx.fillStyle = 'rgba(2,6,24,0.0)';
      egCtx.clearRect(0, 0, W, H);
      // Grid line at 1e-6 and 1e-3
      egCtx.strokeStyle = 'rgba(0,220,180,0.08)';
      egCtx.lineWidth = 1;
      [0.2, 0.5, 0.8].forEach(function (y) {
        egCtx.beginPath(); egCtx.moveTo(0, y * H); egCtx.lineTo(W, y * H); egCtx.stroke();
      });
      if (energyHistory.length < 2) return;
      var maxVal = Math.max.apply(null, energyHistory) || 1e-10;
      egCtx.beginPath();
      energyHistory.forEach(function (v, i) {
        var x = (i / (MAX_ENERGY_PTS - 1)) * W;
        var y = H - (Math.log10(v + 1e-15) - Math.log10(1e-15)) / (Math.log10(maxVal + 1e-15) - Math.log10(1e-15)) * H;
        y = Math.max(0, Math.min(H, y));
        i === 0 ? egCtx.moveTo(x, y) : egCtx.lineTo(x, y);
      });
      var grad = egCtx.createLinearGradient(0, 0, W, 0);
      grad.addColorStop(0, 'rgba(0,220,180,0.3)');
      grad.addColorStop(1, energyHistory[energyHistory.length - 1] > 1e-3 ? '#ff4444' : energyHistory[energyHistory.length - 1] > 1e-6 ? '#ffcc44' : '#00ff88');
      egCtx.strokeStyle = grad;
      egCtx.lineWidth = 1.5;
      egCtx.stroke();
    }

    // Toggle energy graph with E key / button
    function toggleEnergyGraph() {
      showEnergyGraph = !showEnergyGraph;
      document.getElementById('energy-graph-wrap').className = showEnergyGraph ? 'visible' : '';
    }

    // ================================================================
    // FEATURE: BODY TOOLTIP ON HOVER
    // ================================================================
    var tooltip = null;
    var hoveredBody = null;

    function initTooltip() {
      tooltip = document.getElementById('body-tooltip');
      canvas.addEventListener('mousemove', onCanvasMouseMove);
      canvas.addEventListener('mouseleave', function () {
        if (tooltip) tooltip.style.display = 'none';
        hoveredBody = null;
      });
    }

    function onCanvasMouseMove(e) {
      if (!tooltip || !simState.currentBodies.length) return;
      var rect = canvas.getBoundingClientRect();
      var mx = e.clientX - rect.left;
      var my = e.clientY - rect.top;
      var cx = canvas.width / 2, cy = canvas.height / 2, scale = simState.scale;
      var best = null, bestDist = 999;
      simState.currentBodies.forEach(function (b) {
        var px = cx + b.x * scale, py = cy + b.y * scale;
        var d = Math.sqrt((mx - px) * (mx - px) + (my - py) * (my - py));
        if (d < Math.max((b.radius || 5) + 12, 20) && d < bestDist) {
          bestDist = d; best = b;
        }
      });
      if (best) {
        hoveredBody = best;
        var spd = Math.sqrt((best.vx || 0) * (best.vx || 0) + (best.vy || 0) * (best.vy || 0));
        var r = Math.sqrt(best.x * best.x + best.y * best.y);
        tooltip.innerHTML =
          '<div class="tt-name">' + best.name + '</div>' +
          '<div class="tt-row"><span class="tt-key">mass</span><span class="tt-val">' + (best.mass || 0).toExponential(2) + ' M‚òâ</span></div>' +
          '<div class="tt-row"><span class="tt-key">pos r</span><span class="tt-val">' + r.toFixed(3) + ' AU</span></div>' +
          '<div class="tt-row"><span class="tt-key">speed</span><span class="tt-val">' + spd.toFixed(4) + ' AU/yr</span></div>' +
          '<div class="tt-row"><span class="tt-key">x</span><span class="tt-val">' + best.x.toFixed(4) + '</span></div>' +
          '<div class="tt-row"><span class="tt-key">y</span><span class="tt-val">' + best.y.toFixed(4) + '</span></div>';
        // Position tooltip: keep inside canvas
        var tw = 180, th = 110;
        var tx = mx + 16, ty = my - th / 2;
        var cw = rect.width, ch = rect.height;
        if (tx + tw > cw) tx = mx - tw - 10;
        if (ty < 0) ty = 4;
        if (ty + th > ch) ty = ch - th - 4;
        tooltip.style.left = tx + 'px';
        tooltip.style.top = ty + 'px';
        tooltip.style.display = 'block';
      } else {
        tooltip.style.display = 'none';
        hoveredBody = null;
      }
    }

    // ================================================================
    // FEATURE: KEYBOARD SHORTCUTS
    // ================================================================
    document.addEventListener('keydown', function (e) {
      // Ignore when typing in input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      switch (e.key) {
        case ' ':
          e.preventDefault();
          document.getElementById('btn-pause').click();
          break;
        case 'r': case 'R':
          document.getElementById('btn-reset').click();
          break;
        case 's': case 'S':
          document.getElementById('btn-screenshot').click();
          break;
        case 't': case 'T':
          document.getElementById('btn-trail').click();
          break;
        case 'g': case 'G':
          document.getElementById('btn-glow').click();
          break;
        case 'l': case 'L':
          document.getElementById('btn-lbl').click();
          break;
        case 'e': case 'E':
          toggleEnergyGraph();
          break;
        case 'c': case 'C':
          trailColorMode = !trailColorMode;
          trailStore = {};
          break;
        case 'u': case 'U':
          copyShareURL();
          break;
        case 'Escape':
          closeEditor();
          document.getElementById('preset-menu').classList.remove('open');
          break;
      }
    });

    // ================================================================
    // FEATURE: SHAREABLE SCENARIO URLS
    // ================================================================
    function copyShareURL() {
      var scenario = {
        name: simState.scenarioName,
        bodies: simState.currentBodies
      };
      try {
        var encoded = btoa(JSON.stringify(scenario));
        var url = window.location.origin + window.location.pathname + '?scenario=' + encoded;
        navigator.clipboard.writeText(url).then(function () {
          addMsg('sys', 'üîó Share URL copied to clipboard!', null);
        }).catch(function () {
          // Fallback: show in chat
          addMsg('sys', 'üîó Share URL (copy manually):
' + url, null);
        });
      } catch (e) {
        addMsg('err', 'Could not generate share URL', null);
      }
    }

    function loadScenarioFromURL() {
      var params = new URLSearchParams(window.location.search);
      var encoded = params.get('scenario');
      if (!encoded) return;
      try {
        var scenario = JSON.parse(atob(encoded));
        if (scenario && scenario.name) {
          // Pre-fill the prompt input and auto-launch
          var inp = document.getElementById('sim-in');
          if (inp) { inp.value = scenario.name; }
          addMsg('sys', 'üîó Loaded shared scenario: ' + scenario.name, null);
          setTimeout(function () { startSim(scenario.name); }, 800);
        }
      } catch (e) { /* invalid URL param, ignore */ }
    }

    // ================================================================
    // FEATURE: SCENARIO PRESETS DROPDOWN
    // ================================================================
    var PRESETS = [
      { group: 'Classic Orbits' },
      { name: 'Solar System', icon: '‚òâ', prompt: 'The full solar system with all 8 planets orbiting the sun' },
      { name: 'Earth-Moon System', icon: 'üåï', prompt: 'Earth and Moon orbiting their common center of mass' },
      { name: 'Binary Stars', icon: '‚òÖ', prompt: 'Two equal mass stars in a circular binary orbit' },
      { name: 'Triple Star System', icon: '‚ú®', prompt: 'Hierarchical triple star system with stable outer orbit' },
      { group: 'Chaos & Resonance' },
      { name: 'Figure-8 Three Body', icon: '‚àû', prompt: 'Three equal mass bodies in the figure-8 choreography orbit' },
      { name: '2:1 Orbital Resonance', icon: 'üîÑ', prompt: 'Two planets locked in 2:1 mean motion resonance around a star' },
      { name: 'Lagrange Points', icon: '‚ñ≥', prompt: 'Jupiter and a trojan asteroid at L4 Lagrange point' },
      { name: 'Chaotic Three Body', icon: 'üí´', prompt: 'Three unequal mass bodies in chaotic gravitational interaction' },
      { group: 'Collisions & Mergers' },
      { name: 'Planetary Collision', icon: 'üí•', prompt: 'Two planets on collision course around a central star with collisions enabled' },
      { name: 'Galaxy Merger', icon: 'üåÄ', prompt: 'Two clusters of stars passing through each other in a galactic merger' },
      { name: 'Rogue Planet', icon: 'üåë', prompt: 'A rogue planet flying through a planetary system and disrupting orbits' },
      { group: 'Exotic Systems' },
      { name: 'Circumbinary Planet', icon: 'üäô', prompt: 'A Tatooine-like planet orbiting around a binary star system' },
      { name: 'Kozai Mechanism', icon: 'üîÉ', prompt: 'Kozai-Lidov mechanism with inclined outer perturber causing eccentricity oscillation' },
      { name: 'Hot Jupiter Migration', icon: 'üî•', prompt: 'A hot Jupiter migrating inward through a planetary system via gravitational scattering' },
    ];

    function buildPresetMenu() {
      var menu = document.getElementById('preset-menu');
      menu.innerHTML = '';
      PRESETS.forEach(function (p) {
        if (p.group) {
          var div = document.createElement('div');
          div.className = 'preset-group';
          div.textContent = p.group;
          menu.appendChild(div);
        } else {
          var item = document.createElement('div');
          item.className = 'preset-item';
          item.innerHTML = '<span>' + p.icon + '</span><span>' + p.name + '</span>';
          item.addEventListener('click', function () {
            document.getElementById('preset-menu').classList.remove('open');
            var inp = document.getElementById('sim-in');
            if (inp) inp.value = p.name;
            startSim(p.prompt);
          });
          menu.appendChild(item);
        }
      });
    }

    document.getElementById('btn-presets').addEventListener('click', function (e) {
      e.stopPropagation();
      document.getElementById('preset-menu').classList.toggle('open');
    });
    document.addEventListener('click', function () {
      document.getElementById('preset-menu').classList.remove('open');
    });

    // ================================================================
    // FEATURE: CUSTOM SCENARIO EDITOR
    // ================================================================
    var editorBodies = [];
    var edBodyId = 0;

    function defaultBody() {
      return {
        id: ++edBodyId,
        name: 'Body ' + edBodyId,
        mass: 1e-3,
        x: (Math.random() - 0.5) * 4,
        y: (Math.random() - 0.5) * 4,
        vx: (Math.random() - 0.5) * 2,
        vy: (Math.random() - 0.5) * 2,
        radius: 6,
        color: '#' + Math.floor(Math.random() * 0xffffff).toString(16).padStart(6, '0'),
        type: 'planet'
      };
    }

    function renderEditorBodies() {
      var list = document.getElementById('ed-body-list');
      list.innerHTML = '';
      if (editorBodies.length === 0) {
        list.innerHTML = '<div style="color:rgba(120,160,200,0.4);font-size:10px;text-align:center;padding:24px">No bodies yet.
        Click ‚äï Add Body to start.</div > ';
        return;
      }
      editorBodies.forEach(function (b) {
        var card = document.createElement('div');
        card.className = 'ed-body-card';
        card.innerHTML =
          '<div class="ed-body-title">' +
          '<span>' + b.name + '</span>' +
          '<button class="ed-del" data-id="' + b.id + '">√ó</button>' +
          '</div>' +
          '<div class="ed-row"><span class="ed-lbl">Name</span><input class="ed-inp" data-id="' + b.id + '" data-field="name" value="' + b.name + '"></div>' +
          '<div class="ed-row"><span class="ed-lbl">Mass</span><input class="ed-inp" data-id="' + b.id + '" data-field="mass" type="number" step="0.0001" value="' + b.mass + '"></div>' +
          '<div class="ed-row"><span class="ed-lbl">x</span><input class="ed-inp" data-id="' + b.id + '" data-field="x" type="number" step="0.1" value="' + b.x.toFixed(3) + '"></div>' +
          '<div class="ed-row"><span class="ed-lbl">y</span><input class="ed-inp" data-id="' + b.id + '" data-field="y" type="number" step="0.1" value="' + b.y.toFixed(3) + '"></div>' +
          '<div class="ed-row"><span class="ed-lbl">vx</span><input class="ed-inp" data-id="' + b.id + '" data-field="vx" type="number" step="0.01" value="' + b.vx.toFixed(4) + '"></div>' +
          '<div class="ed-row"><span class="ed-lbl">vy</span><input class="ed-inp" data-id="' + b.id + '" data-field="vy" type="number" step="0.01" value="' + b.vy.toFixed(4) + '"></div>' +
          '<div class="ed-row"><span class="ed-lbl">r</span><input class="ed-inp" data-id="' + b.id + '" data-field="radius" type="number" step="1" min="2" max="30" value="' + b.radius + '"></div>' +
          '<div class="ed-row"><span class="ed-lbl">Color</span><input class="ed-color" data-id="' + b.id + '" data-field="color" type="color" value="' + b.color + '"></div>';
        list.appendChild(card);
      });

      // Wire up inputs
      list.querySelectorAll('.ed-inp, .ed-color').forEach(function (inp) {
        inp.addEventListener('change', function () {
          var id = parseInt(this.dataset.id);
          var field = this.dataset.field;
          var body = editorBodies.find(function (b) { return b.id === id; });
          if (!body) return;
          var numFields = ['mass', 'x', 'y', 'vx', 'vy', 'radius'];
          body[field] = numFields.indexOf(field) !== -1 ? parseFloat(this.value) : this.value;
          if (field === 'name') renderEditorBodies();
        });
      });
      list.querySelectorAll('.ed-del').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var id = parseInt(this.dataset.id);
          editorBodies = editorBodies.filter(function (b) { return b.id !== id; });
          renderEditorBodies();
        });
      });
    }

    function openEditor() {
      // Snapshot current bodies into editor if live
      if (simState.currentBodies.length > 0 && editorBodies.length === 0) {
        editorBodies = simState.currentBodies.map(function (b, i) {
          return {
            id: ++edBodyId, name: b.name || ('Body ' + i), mass: b.mass || 1e-3,
            x: b.x, y: b.y, vx: b.vx || 0, vy: b.vy || 0,
            radius: b.radius || 6, color: b.color || '#aaaaaa', type: b.type || 'planet'
          };
        });
      }
      renderEditorBodies();
      document.getElementById('editor-panel').classList.add('open');
      document.getElementById('btn-editor').classList.add('active');
    }

    function closeEditor() {
      document.getElementById('editor-panel').classList.remove('open');
      document.getElementById('btn-editor').classList.remove('active');
    }

    document.getElementById('btn-editor').addEventListener('click', function () {
      document.getElementById('editor-panel').classList.contains('open') ? closeEditor() : openEditor();
    });
    document.getElementById('ed-close').addEventListener('click', closeEditor);

    document.getElementById('ed-add').addEventListener('click', function () {
      // Add central star if first body
      if (editorBodies.length === 0) {
        editorBodies.push({
          id: ++edBodyId, name: 'Star', mass: 1.0,
          x: 0, y: 0, vx: 0, vy: 0, radius: 18, color: '#fff200', type: 'star'
        });
      } else {
        editorBodies.push(defaultBody());
      }
      renderEditorBodies();
    });

    document.getElementById('ed-run').addEventListener('click', function () {
      if (editorBodies.length === 0) {
        addMsg('err', 'Add at least one body first', null); return;
      }
      closeEditor();
      // Build prompt from body names and launch
      var names = editorBodies.map(function (b) { return b.name; }).join(', ');
      var prompt = 'Custom scenario: ' + names;
      simState.scenarioName = prompt;
      // Send via WebSocket as custom scenario
      connectWS(function () {
        wsSend({
          action: 'start',
          prompt: prompt,
          fps: 30,
          steps_per_frame: simState.speedMult,
          custom_bodies: editorBodies
        });
      });
      addMsg('sys', '‚úè Launched custom scenario with ' + editorBodies.length + ' bodies', null);
    });

    // ================================================================
    // INIT all features on page load
    // ================================================================
    window.addEventListener('load', function () {
      initTooltip();
      initEnergyGraph();
      buildPresetMenu();
      loadScenarioFromURL();

      // Add share URL button to toolbar (dynamic - avoids HTML clutter)
      var shareBtn = document.createElement('button');
      shareBtn.className = 'btn-screenshot';
      shareBtn.id = 'btn-share';
      shareBtn.title = 'Copy shareable URL (U)';
      shareBtn.textContent = 'üîó Share';
      shareBtn.addEventListener('click', copyShareURL);
      var recBtn = document.getElementById('btn-record');
      if (recBtn) recBtn.parentNode.insertBefore(shareBtn, recBtn.nextSibling);

      // Patch renderFrame to also call trail store + energy graph
      var _origRenderFrame = renderFrame;
      renderFrame = function (data) {
        _origRenderFrame(data);
        if (simState.showTrails && data.bodies) updateTrailStore(data.bodies);
        if (trailColorMode && data.bodies) drawSpeedTrails(canvas.width, canvas.height);
        updateEnergyGraph(data.energy_drift || 0);
      };
    });

    // Add C key hint to kb-hint
    document.addEventListener('DOMContentLoaded', function () {
      var hint = document.getElementById('kb-hint');
      if (hint) hint.innerHTML += '<br>C speed-color trails &nbsp; U share URL';
    });
  </script>
</body>

</html>