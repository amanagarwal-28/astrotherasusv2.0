<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASTRO THESAURUS â€” REBOUND Engine</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=JetBrains+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap');

    :root {
      --void: #00000c;
      --deep: #020412;
      --panel: #04081a;
      --chat-bg: #010a14;
      --chat-border: rgba(0, 220, 180, 0.22);
      --border: rgba(60, 120, 255, 0.16);
      --accent: #2c6fff;
      --pulse: #00e5ff;
      --teal: #00dcb4;
      --nova: #ff2060;
      --green: #00ff99;
      --gold: #ffd060;
      --text: #ccdaff;
      --text-bright: #eef3ff;
      --dim: #445580;
      --bright: #ffffff;
    }

    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      background: var(--void);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      overflow: hidden;
    }

    /* â”€â”€ DEEP SPACE BACKGROUND â”€â”€ */
    #bg-canvas {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    /* Nebula glow overlays */
    .nebula {
      position: fixed;
      border-radius: 50%;
      pointer-events: none;
      z-index: 1;
      filter: blur(80px);
      opacity: 0.055;
    }

    .nebula-1 {
      width: 600px;
      height: 600px;
      top: -100px;
      left: -100px;
      background: radial-gradient(circle, #3060ff, transparent 70%);
      animation: nbf 18s ease-in-out infinite alternate;
    }

    .nebula-2 {
      width: 500px;
      height: 500px;
      bottom: -80px;
      right: -80px;
      background: radial-gradient(circle, #00dcb4, transparent 70%);
      animation: nbf 22s ease-in-out infinite alternate-reverse;
    }

    .nebula-3 {
      width: 350px;
      height: 350px;
      top: 40%;
      left: 35%;
      background: radial-gradient(circle, #8040ff, transparent 70%);
      animation: nbf 26s ease-in-out infinite;
    }

    @keyframes nbf {
      0% {
        opacity: 0.045
      }

      100% {
        opacity: 0.08
      }
    }

    /* Grid overlay */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 1;
      pointer-events: none;
      background-image:
        linear-gradient(rgba(50, 110, 255, 0.018) 1px, transparent 1px),
        linear-gradient(90deg, rgba(50, 110, 255, 0.018) 1px, transparent 1px);
      background-size: 52px 52px;
    }

    /* â”€â”€ APP LAYOUT â”€â”€ */
    .app {
      position: relative;
      z-index: 2;
      display: grid;
      grid-template-rows: 64px auto 1fr;
      grid-template-columns: 1fr 380px;
      height: 100vh;
      gap: 0;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      grid-column: 1/-1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: rgba(2, 4, 18, 0.96);
      border-bottom: 1px solid var(--border);
      position: relative;
      backdrop-filter: blur(12px);
    }

    header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, var(--teal) 30%, var(--accent) 60%, transparent 100%);
      opacity: 0.4;
    }

    /* LOGO */
    .logo {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-icon {
      position: relative;
      width: 42px;
      height: 42px;
      flex-shrink: 0;
    }

    .logo-icon svg {
      width: 42px;
      height: 42px;
    }

    .logo-orbit {
      animation: orbit-spin 8s linear infinite;
      transform-origin: 21px 21px;
    }

    @keyframes orbit-spin {
      from {
        transform: rotate(0deg)
      }

      to {
        transform: rotate(360deg)
      }
    }

    .logo-pulse {
      animation: logo-glow 3s ease-in-out infinite;
    }

    @keyframes logo-glow {

      0%,
      100% {
        filter: drop-shadow(0 0 4px rgba(0, 229, 255, 0.5));
      }

      50% {
        filter: drop-shadow(0 0 12px rgba(0, 229, 255, 0.9)) drop-shadow(0 0 20px rgba(44, 111, 255, 0.5));
      }
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .logo-name {
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      font-weight: 900;
      letter-spacing: 4px;
      background: linear-gradient(90deg, #fff 0%, var(--pulse) 50%, var(--teal) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
    }

    .logo-sub {
      font-family: 'JetBrains Mono', monospace;
      font-size: 7.5px;
      letter-spacing: 2.5px;
      color: var(--dim);
      text-transform: uppercase;
    }

    /* SIMULATE BAR (center of header) */
    .sim-bar {
      flex: 1;
      max-width: 560px;
      margin: 0 24px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .sim-bar-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 7px;
      letter-spacing: 2px;
      color: var(--teal);
      text-transform: uppercase;
      white-space: nowrap;
      opacity: 0.7;
    }

    .sim-bar-input-wrap {
      flex: 1;
      position: relative;
    }

    #sim-input {
      width: 100%;
      padding: 9px 42px 9px 14px;
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(0, 220, 180, 0.25);
      border-radius: 4px;
      color: var(--text-bright);
      font-family: 'Syne', sans-serif;
      font-size: 12px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    #sim-input:focus {
      border-color: var(--teal);
      box-shadow: 0 0 0 2px rgba(0, 220, 180, 0.08), 0 0 16px rgba(0, 220, 180, 0.12);
    }

    #sim-input::placeholder {
      color: var(--dim);
      font-size: 11px;
    }

    #sim-go {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--teal), #00a080);
      border: none;
      border-radius: 3px;
      color: #000;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.18s;
      font-weight: 700;
    }

    #sim-go:hover {
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 0 14px rgba(0, 220, 180, 0.4);
    }

    #sim-go:disabled {
      opacity: 0.35;
      cursor: not-allowed;
      transform: translateY(-50%) scale(1);
    }

    /* HEADER RIGHT STATS */
    .hstats {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .hs {
      padding: 4px 11px;
      border: 1px solid var(--border);
      border-radius: 3px;
      background: rgba(44, 111, 255, 0.04);
      text-align: center;
    }

    .hs-l {
      display: block;
      font-family: 'JetBrains Mono', monospace;
      font-size: 6px;
      letter-spacing: 2px;
      color: var(--dim);
      text-transform: uppercase;
    }

    .hs-v {
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      color: var(--pulse);
      font-weight: 700;
    }

    .pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border: 1px solid rgba(0, 255, 153, 0.2);
      border-radius: 20px;
      background: rgba(0, 255, 153, 0.04);
      margin-left: 6px;
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 7px var(--green);
      animation: bl 2s ease-in-out infinite;
    }

    @keyframes bl {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.2
      }
    }

    .pill-t {
      font-family: 'JetBrains Mono', monospace;
      font-size: 7.5px;
      letter-spacing: 1px;
      color: var(--green);
      text-transform: uppercase;
    }

    /* â”€â”€ EXAMPLE CHIPS BAR â”€â”€ */
    #chips-bar {
      grid-column: 1/-1;
      padding: 6px 20px;
      background: rgba(2, 4, 18, 0.85);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 5px;
      align-items: center;
      overflow-x: auto;
      scrollbar-width: none;
    }

    #chips-bar::-webkit-scrollbar {
      display: none;
    }

    .chips-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 7px;
      letter-spacing: 2px;
      color: var(--dim);
      text-transform: uppercase;
      white-space: nowrap;
      margin-right: 4px;
    }

    .chip {
      padding: 3px 10px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      border: 1px solid rgba(44, 111, 255, 0.2);
      border-radius: 12px;
      color: rgba(100, 160, 255, 0.6);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.15s;
      background: rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
    }

    .chip:hover {
      border-color: var(--teal);
      color: var(--teal);
      background: rgba(0, 220, 180, 0.05);
      transform: translateY(-1px);
    }

    /* â”€â”€ CENTER (simulation) â”€â”€ */
    #center {
      display: flex;
      flex-direction: column;
      background: var(--void);
      position: relative;
      overflow: hidden;
      border-right: 1px solid var(--border);
    }

    #vtabs {
      display: flex;
      padding: 5px 14px;
      background: rgba(2, 4, 18, 0.97);
      border-bottom: 1px solid var(--border);
      gap: 4px;
      align-items: center;
    }

    .vtab {
      padding: 5px 18px;
      font-family: 'Orbitron', sans-serif;
      font-size: 7.5px;
      letter-spacing: 2px;
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.4);
      color: var(--dim);
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 2px;
    }

    .vtab.active {
      background: rgba(0, 220, 180, 0.1);
      border-color: var(--teal);
      color: var(--teal);
    }

    .vtab-sp {
      flex: 1;
    }

    #energy-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      letter-spacing: 1px;
      color: var(--green);
      padding: 3px 9px;
      border: 1px solid rgba(0, 255, 153, 0.2);
      border-radius: 10px;
      background: rgba(0, 255, 153, 0.04);
    }

    #status-bar {
      padding: 4px 14px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 7.5px;
      letter-spacing: 1px;
      color: var(--dim);
      border-bottom: 1px solid rgba(44, 111, 255, 0.08);
      min-height: 22px;
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(0, 0, 0, 0.2);
    }

    #status-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--dim);
      flex-shrink: 0;
    }

    #status-dot.ok {
      background: var(--green);
      box-shadow: 0 0 6px var(--green);
    }

    #status-dot.err {
      background: var(--nova);
      box-shadow: 0 0 6px var(--nova);
    }

    #status-dot.spin {
      background: #ffaa00;
      animation: bl 0.6s infinite;
    }

    #canvas-wrap {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    #sim-canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    /* Canvas corner brackets */
    .cv-corner {
      position: absolute;
      pointer-events: none;
      width: 16px;
      height: 16px;
    }

    .cv-corner.tl {
      top: 12px;
      left: 12px;
      border-top: 1px solid rgba(0, 220, 180, 0.3);
      border-left: 1px solid rgba(0, 220, 180, 0.3);
    }

    .cv-corner.tr {
      top: 12px;
      right: 12px;
      border-top: 1px solid rgba(0, 220, 180, 0.3);
      border-right: 1px solid rgba(0, 220, 180, 0.3);
    }

    .cv-corner.bl {
      bottom: 12px;
      left: 12px;
      border-bottom: 1px solid rgba(0, 220, 180, 0.3);
      border-left: 1px solid rgba(0, 220, 180, 0.3);
    }

    .cv-corner.br {
      bottom: 12px;
      right: 12px;
      border-bottom: 1px solid rgba(0, 220, 180, 0.3);
      border-right: 1px solid rgba(0, 220, 180, 0.3);
    }

    .cv-hud {
      position: absolute;
      font-family: 'JetBrains Mono', monospace;
      font-size: 7.5px;
      letter-spacing: 1px;
      color: rgba(0, 220, 180, 0.35);
      text-transform: uppercase;
      line-height: 2;
      pointer-events: none;
    }

    #hud-tl {
      top: 16px;
      left: 18px;
    }

    #hud-tr {
      top: 16px;
      right: 18px;
      text-align: right;
    }

    #hud-bl {
      bottom: 16px;
      left: 18px;
    }

    /* Controls overlay (bottom of canvas) */
    #ctrl-overlay {
      position: absolute;
      bottom: 14px;
      right: 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }

    .ctrl-group {
      display: flex;
      gap: 3px;
    }

    .btn {
      padding: 5px 9px;
      border: 1px solid var(--border);
      border-radius: 3px;
      background: rgba(0, 0, 0, 0.55);
      color: var(--dim);
      font-family: 'JetBrains Mono', monospace;
      font-size: 7.5px;
      cursor: pointer;
      transition: all 0.15s;
      letter-spacing: 1px;
      backdrop-filter: blur(4px);
    }

    .btn:hover {
      border-color: var(--teal);
      color: var(--text);
    }

    .btn.on {
      background: rgba(0, 220, 180, 0.1);
      border-color: var(--teal);
      color: var(--teal);
    }

    .sl-mini {
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 4px 8px;
      backdrop-filter: blur(4px);
      min-width: 140px;
    }

    .sl-lbl {
      display: flex;
      justify-content: space-between;
      font-family: 'JetBrains Mono', monospace;
      font-size: 7px;
      color: var(--dim);
      margin-bottom: 3px;
    }

    .sl-lbl span:last-child {
      color: var(--teal);
    }

    input[type=range] {
      width: 100%;
      accent-color: var(--teal);
      height: 3px;
      cursor: pointer;
    }

    #watermark {
      position: absolute;
      bottom: 52px;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Orbitron', sans-serif;
      font-size: 32px;
      font-weight: 900;
      color: rgba(255, 255, 255, 0.018);
      letter-spacing: 10px;
      white-space: nowrap;
      pointer-events: none;
    }

    #empty-state {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: none;
    }

    .es-ring {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 1px solid rgba(0, 220, 180, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 42px;
      margin: 0 auto 16px;
      animation: flt 4s ease-in-out infinite;
      box-shadow: 0 0 60px rgba(0, 220, 180, 0.05), inset 0 0 30px rgba(0, 220, 180, 0.03);
    }

    @keyframes flt {

      0%,
      100% {
        transform: translateY(0)
      }

      50% {
        transform: translateY(-10px)
      }
    }

    .es-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 3px;
      color: rgba(0, 220, 180, 0.35);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .es-txt {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      letter-spacing: 2px;
      color: rgba(44, 111, 255, 0.3);
      text-transform: uppercase;
      line-height: 2.4;
    }

    #plot-wrap {
      flex: 1;
      display: none;
      align-items: center;
      justify-content: center;
      background: #000008;
      padding: 14px;
    }

    #plot-img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 5px;
      border: 1px solid var(--border);
      box-shadow: 0 0 40px rgba(44, 111, 255, 0.1);
      display: none;
    }

    #plot-empty {
      text-align: center;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: 2px;
      color: rgba(44, 111, 255, 0.22);
    }

    /* Active bodies strip */
    #body-strip {
      position: absolute;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 6px;
      pointer-events: none;
      z-index: 5;
    }

    .bstrip-item {
      display: flex;
      align-items: center;
      gap: 4px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(44, 111, 255, 0.15);
      border-radius: 12px;
      padding: 3px 8px;
      backdrop-filter: blur(4px);
    }

    .bstrip-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .bstrip-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: 7px;
      color: rgba(180, 210, 255, 0.7);
      letter-spacing: 1px;
    }

    .bstrip-v {
      font-family: 'JetBrains Mono', monospace;
      font-size: 6px;
      color: var(--dim);
    }

    /* â”€â”€ RIGHT PANEL (CHAT) â”€â”€ */
    #right {
      background: var(--chat-bg);
      border-left: 1px solid var(--chat-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    /* Subtle different texture for chat */
    #right::before {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background:
        radial-gradient(ellipse at 50% 0%, rgba(0, 220, 180, 0.04) 0%, transparent 60%),
        linear-gradient(180deg, rgba(0, 10, 20, 0.3) 0%, transparent 30%);
    }

    #right>* {
      position: relative;
      z-index: 1;
    }

    .rh {
      padding: 10px 14px 9px;
      border-bottom: 1px solid var(--chat-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0, 8, 16, 0.6);
    }

    .rh-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 8px;
      letter-spacing: 3px;
      color: var(--teal);
      text-transform: uppercase;
    }

    .rh-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 7px;
      letter-spacing: 1px;
      color: rgba(0, 220, 180, 0.4);
      padding: 2px 7px;
      border: 1px solid rgba(0, 220, 180, 0.15);
      border-radius: 8px;
    }

    #chat-msgs {
      flex: 1;
      overflow-y: auto;
      padding: 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
    }

    #chat-msgs::-webkit-scrollbar {
      width: 2px;
    }

    #chat-msgs::-webkit-scrollbar-thumb {
      background: var(--teal);
      border-radius: 2px;
      opacity: 0.4;
    }

    .welcome {
      padding: 14px;
      border-radius: 6px;
      background: linear-gradient(135deg, rgba(0, 220, 180, 0.04), rgba(44, 111, 255, 0.03));
      border: 1px solid rgba(0, 220, 180, 0.15);
      position: relative;
      overflow: hidden;
    }

    .welcome::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--teal), transparent);
      opacity: 0.5;
    }

    .wc-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--teal);
      margin-bottom: 8px;
    }

    .wc-body {
      font-size: 11px;
      color: rgba(180, 210, 255, 0.65);
      line-height: 1.9;
    }

    .wc-exs {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .wce {
      padding: 6px 10px;
      font-size: 10px;
      border: 1px solid rgba(0, 220, 180, 0.12);
      border-radius: 4px;
      color: rgba(0, 220, 180, 0.55);
      cursor: pointer;
      transition: all 0.15s;
      background: rgba(0, 0, 0, 0.25);
      font-family: 'JetBrains Mono', monospace;
    }

    .wce:hover {
      border-color: var(--teal);
      color: var(--teal);
      background: rgba(0, 220, 180, 0.05);
      transform: translateX(3px);
    }

    .msg {
      animation: mi 0.22s ease;
    }

    @keyframes mi {
      from {
        opacity: 0;
        transform: translateY(6px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    .msg-u {
      align-self: flex-end;
      max-width: 90%;
      padding: 10px 14px;
      font-size: 12px;
      line-height: 1.6;
      background: rgba(44, 111, 255, 0.12);
      border: 1px solid rgba(44, 111, 255, 0.25);
      border-radius: 8px 8px 2px 8px;
      color: var(--text-bright);
    }

    .msg-a {
      width: 100%;
      padding: 12px 14px;
      font-size: 12px;
      line-height: 1.85;
      background: rgba(0, 220, 180, 0.04);
      border: 1px solid rgba(0, 220, 180, 0.12);
      border-radius: 2px 8px 8px 8px;
      color: var(--text);
      position: relative;
    }

    .msg-a-tag {
      position: absolute;
      top: -9px;
      left: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 7px;
      letter-spacing: 2px;
      color: var(--teal);
      background: var(--chat-bg);
      padding: 1px 6px;
      border: 1px solid rgba(0, 220, 180, 0.2);
      border-radius: 2px;
    }

    .msg-sys {
      align-self: center;
      font-family: 'JetBrains Mono', monospace;
      font-size: 7.5px;
      letter-spacing: 2px;
      color: var(--dim);
      padding: 2px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      text-transform: uppercase;
    }

    .msg-err {
      padding: 10px 14px;
      font-size: 11px;
      background: rgba(255, 32, 96, 0.06);
      border: 1px solid rgba(255, 32, 96, 0.2);
      border-radius: 4px;
      color: var(--nova);
    }

    .chat-plot {
      width: 100%;
      border-radius: 4px;
      border: 1px solid var(--border);
      display: block;
      margin-top: 8px;
      cursor: pointer;
    }

    .dtable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 10px;
    }

    .dtable td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(0, 220, 180, 0.06);
    }

    .dtable td:first-child {
      color: var(--dim);
    }

    .dtable td:last-child {
      color: var(--teal);
      text-align: right;
      font-family: 'JetBrains Mono', monospace;
    }

    .typing {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 12px 14px;
    }

    .typing span {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--teal);
      animation: td 1.2s ease-in-out infinite;
      opacity: 0.4;
    }

    .typing span:nth-child(2) {
      animation-delay: .2s
    }

    .typing span:nth-child(3) {
      animation-delay: .4s
    }

    @keyframes td {

      0%,
      60%,
      100% {
        transform: translateY(0);
        opacity: 0.3
      }

      30% {
        transform: translateY(-6px);
        opacity: 1
      }
    }

    #input-area {
      padding: 10px;
      border-top: 1px solid var(--chat-border);
      background: rgba(0, 8, 16, 0.7);
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .api-row {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border: 1px solid var(--border);
      border-radius: 3px;
      background: rgba(0, 0, 0, 0.3);
    }

    .api-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
    }

    .api-dot.on {
      background: var(--green);
      box-shadow: 0 0 5px var(--green);
    }

    .api-dot.off {
      background: #ff4444;
    }

    .api-dot.wait {
      background: #ffaa00;
      animation: bl 1s infinite;
    }

    .api-lbl {
      font-family: 'JetBrains Mono', monospace;
      font-size: 7.5px;
      letter-spacing: 1px;
      color: var(--dim);
      text-transform: uppercase;
    }

    .inp-row {
      display: flex;
      gap: 6px;
      align-items: flex-end;
    }

    #chat-in {
      flex: 1;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(0, 220, 180, 0.2);
      border-radius: 5px;
      color: var(--text-bright);
      font-family: 'Syne', sans-serif;
      font-size: 12px;
      padding: 9px 12px;
      resize: none;
      min-height: 40px;
      max-height: 90px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      line-height: 1.5;
    }

    #chat-in:focus {
      border-color: var(--teal);
      box-shadow: 0 0 0 2px rgba(0, 220, 180, 0.07);
    }

    #chat-in::placeholder {
      color: var(--dim);
      font-size: 11px;
    }

    #send {
      width: 40px;
      height: 40px;
      flex-shrink: 0;
      background: linear-gradient(135deg, var(--teal), #008060);
      border: none;
      border-radius: 5px;
      color: #000;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.18s;
      font-weight: 700;
    }

    #send:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0, 220, 180, 0.35);
    }

    #send:disabled {
      opacity: 0.35;
      cursor: not-allowed;
      transform: none;
    }
  </style>
</head>

<body>

  <!-- DEEP SPACE BACKGROUND -->
  <canvas id="bg-canvas"></canvas>
  <div class="nebula nebula-1"></div>
  <div class="nebula nebula-2"></div>
  <div class="nebula nebula-3"></div>

  <div class="app">

    <!-- â”€â”€ HEADER â”€â”€ -->
    <header>
      <div class="logo">
        <!-- SVG Logo -->
        <div class="logo-icon">
          <svg viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg" class="logo-pulse">
            <!-- Outer orbit ring -->
            <circle cx="21" cy="21" r="19" stroke="rgba(0,229,255,0.3)" stroke-width="0.8" />
            <!-- Tilted orbit ellipse -->
            <ellipse cx="21" cy="21" rx="19" ry="7" stroke="rgba(44,111,255,0.5)" stroke-width="0.8"
              transform="rotate(-30 21 21)" />
            <!-- Orbiting dot -->
            <g class="logo-orbit">
              <circle cx="40" cy="21" r="2.5" fill="#00e5ff" />
              <circle cx="40" cy="21" r="2.5" fill="#00e5ff" opacity="0.4" r="4" />
            </g>
            <!-- Central star -->
            <circle cx="21" cy="21" r="5" fill="url(#stargrd)" />
            <circle cx="21" cy="21" r="3" fill="#fff" opacity="0.9" />
            <!-- Star rays -->
            <line x1="21" y1="13" x2="21" y2="16" stroke="#00e5ff" stroke-width="1" opacity="0.6" />
            <line x1="21" y1="26" x2="21" y2="29" stroke="#00e5ff" stroke-width="1" opacity="0.6" />
            <line x1="13" y1="21" x2="16" y2="21" stroke="#00e5ff" stroke-width="1" opacity="0.6" />
            <line x1="26" y1="21" x2="29" y2="21" stroke="#00e5ff" stroke-width="1" opacity="0.6" />
            <defs>
              <radialGradient id="stargrd" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="#fff" />
                <stop offset="100%" stop-color="#00e5ff" stop-opacity="0.6" />
              </radialGradient>
            </defs>
          </svg>
        </div>
        <div class="logo-text">
          <div class="logo-name">ASTRO THESAURUS</div>
          <div class="logo-sub">REBOUND N-Body Â· Simulate Anything</div>
        </div>
      </div>

      <!-- SIMULATE PROMPT BAR -->
      <div class="sim-bar">
        <span class="sim-bar-label">â–¶ Simulate</span>
        <div class="sim-bar-input-wrap">
          <input id="sim-input" type="text"
            placeholder="Describe any gravitational system â€” e.g. two neutron stars spiraling in...">
          <button id="sim-go">â–¶</button>
        </div>
      </div>

      <!-- STATS -->
      <div class="hstats">
        <div class="hs"><span class="hs-l">Scenario</span><span class="hs-v" id="hs-sc">â€”</span></div>
        <div class="hs"><span class="hs-l">Bodies</span><span class="hs-v" id="hs-bd">0</span></div>
        <div class="hs"><span class="hs-l">Time</span><span class="hs-v" id="hs-t">0.000</span></div>
        <div class="hs"><span class="hs-l">FPS</span><span class="hs-v" id="hs-fps">â€”</span></div>
        <div class="pill">
          <div class="dot"></div><span class="pill-t">REBOUND</span>
        </div>
      </div>
    </header>

    <!-- â”€â”€ CHIPS BAR â”€â”€ -->
    <div id="chips-bar">
      <span class="chips-label">Quick launch â†’</span>
      <div id="chip-list"></div>
    </div>

    <!-- â”€â”€ CENTER (simulation canvas) â”€â”€ -->
    <div id="center">
      <div id="vtabs">
        <button class="vtab active" id="vt-sim" onclick="setView('sim')">â–¶ Live Simulation</button>
        <button class="vtab" id="vt-plot" onclick="setView('plot')">ğŸ“Š Orbital Plot</button>
        <div class="vtab-sp"></div>
        <div id="energy-badge">Î”E/E: â€”</div>
      </div>
      <div id="status-bar">
        <div id="status-dot"></div>
        <span id="status-txt">Ready â€” enter a simulation prompt above</span>
      </div>

      <div id="canvas-wrap">
        <canvas id="sim-canvas"></canvas>
        <div class="cv-corner tl"></div>
        <div class="cv-corner tr"></div>
        <div class="cv-corner bl"></div>
        <div class="cv-corner br"></div>
        <div class="cv-hud" id="hud-tl">
          <div>Astro Thesaurus // REBOUND v4</div>
          <div id="hud-sc">Awaiting simulation</div>
        </div>
        <div class="cv-hud" id="hud-tr">
          <div id="hud-info">Enter a prompt above</div>
          <div id="hud-int"></div>
        </div>
        <div class="cv-hud" id="hud-bl">
          <div id="hud-desc"></div>
        </div>

        <!-- Controls overlay -->
        <div id="ctrl-overlay">
          <div class="ctrl-group">
            <button class="btn" id="btn-pause">â¸ Pause</button>
            <button class="btn" id="btn-reset">â†º Reset</button>
            <button class="btn on" id="btn-trail">â— Trails</button>
            <button class="btn on" id="btn-glow">âœ¦ Glow</button>
            <button class="btn on" id="btn-lbl">âŒ– Labels</button>
            <button class="btn" id="btn-elems">âŠ™ Elements</button>
          </div>
          <div class="sl-mini">
            <div class="sl-lbl"><span>Speed</span><span id="spd-v">1Ã—</span></div>
            <input type="range" id="spd-sl" min="1" max="16" value="1">
          </div>
          <div class="sl-mini">
            <div class="sl-lbl"><span>Trail Length</span><span id="trl-v">Medium</span></div>
            <input type="range" id="trl-sl" min="1" max="10" value="4">
          </div>
        </div>

        <div id="watermark">REBOUND</div>
        <div id="empty-state">
          <div class="es-ring">ğŸŒŒ</div>
          <div class="es-title">Astro Thesaurus</div>
          <div class="es-txt">Type any gravitational system above<br>REBOUND simulates it live in real-time</div>
        </div>
      </div>

      <div id="plot-wrap">
        <div id="plot-empty">ğŸ“¡ No plot yet â€” ask the AI assistant</div>
        <img id="plot-img" alt="Orbital Plot">
      </div>
    </div>

    <!-- â”€â”€ RIGHT PANEL (AI Chat) â”€â”€ -->
    <div id="right">
      <div class="rh">
        <span class="rh-title">âš¡ AI Orbital Assistant</span>
        <span class="rh-badge">RAG Â· Llama 3.1</span>
      </div>
      <div id="chat-msgs">
        <div class="welcome">
          <div class="wc-title">ğŸ›¸ REBOUND + RAG Active</div>
          <div class="wc-body">Ask anything about orbital mechanics in plain English. Simulation prompts auto-launch in
            the viewer.</div>
          <div class="wc-exs">
            <div class="wce" onclick="fillChat('What is a Hohmann transfer?')">â†’ What is a Hohmann transfer?</div>
            <div class="wce" onclick="fillChat('Explain Lagrange points')">â†’ Explain Lagrange points</div>
            <div class="wce" onclick="fillChat('Show Mars orbit for 2 years')">â†’ Show Mars orbit plot</div>
            <div class="wce" onclick="fillSim('TRAPPIST-1 all 7 planets')">âš¡ Simulate TRAPPIST-1</div>
            <div class="wce" onclick="fillSim('two black holes merging')">âš¡ Simulate black holes merging</div>
          </div>
        </div>
      </div>
      <div id="input-area">
        <div class="api-row">
          <div class="api-dot wait" id="api-dot"></div>
          <span class="api-lbl" id="api-lbl">Checking API...</span>
        </div>
        <div class="inp-row">
          <textarea id="chat-in" placeholder="Ask about orbital mechanics, Kepler's laws, exoplanets..."
            rows="2"></textarea>
          <button id="send">â¤</button>
        </div>
      </div>
    </div>

  </div><!-- .app -->

  <script>
    'use strict';

    var API = 'http://localhost:8000';
    var WS_URL = 'ws://localhost:8000/ws/sim';

    // â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var ws = null;
    var simState = {
      playing: false, showTrails: true, showGlow: true, showLabels: true,
      trailAlpha: 0.12, speedMult: 1, currentBodies: [], scale: 180, scenarioName: ''
    };
    var fpsCount = 0, fpsLast = Date.now(), fps = 0;
    var currentView = 'sim';

    // â”€â”€ DEEP SPACE STARFIELD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function () {
      var c = document.getElementById('bg-canvas');
      var ctx = c.getContext('2d');
      var stars = [], shooters = [], nebulaPts = [];

      function resize() { c.width = innerWidth; c.height = innerHeight; }

      function initStars() {
        stars = [];
        // Layer 1: tiny distant stars
        for (var i = 0; i < 600; i++) stars.push({
          x: Math.random() * c.width, y: Math.random() * c.height,
          r: Math.random() * 0.8 + 0.1, a: Math.random() * Math.PI * 2,
          s: Math.random() * 0.3 + 0.01, h: Math.random() * 60 + 190,
          layer: 0
        });
        // Layer 2: medium stars
        for (var i = 0; i < 200; i++) stars.push({
          x: Math.random() * c.width, y: Math.random() * c.height,
          r: Math.random() * 1.4 + 0.4, a: Math.random() * Math.PI * 2,
          s: Math.random() * 0.2 + 0.015, h: Math.random() * 80 + 180,
          layer: 1
        });
        // Layer 3: bright foreground stars with cross flare
        for (var i = 0; i < 40; i++) stars.push({
          x: Math.random() * c.width, y: Math.random() * c.height,
          r: Math.random() * 1.8 + 1, a: Math.random() * Math.PI * 2,
          s: Math.random() * 0.1 + 0.008, h: Math.random() * 40 + 200,
          layer: 2
        });
      }

      function drawStars() {
        stars.forEach(function (s) {
          s.a += s.s * 0.008;
          var al = ((Math.sin(s.a) + 1) / 2) * 0.8 + 0.1;
          // Layer 2: add cross flare
          if (s.layer === 2 && al > 0.6) {
            var fl = al * 0.3;
            ctx.strokeStyle = 'hsla(' + s.h + ',60%,95%,' + fl + ')';
            ctx.lineWidth = 0.5;
            ctx.beginPath(); ctx.moveTo(s.x - s.r * 3, s.y); ctx.lineTo(s.x + s.r * 3, s.y); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(s.x, s.y - s.r * 3); ctx.lineTo(s.x, s.y + s.r * 3); ctx.stroke();
          }
          ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
          ctx.fillStyle = 'hsla(' + s.h + ',50%,92%,' + al + ')'; ctx.fill();
        });
      }

      // Shooting stars
      function maybeShoot() {
        if (Math.random() < 0.004) {
          shooters.push({
            x: Math.random() * c.width * 0.7, y: Math.random() * c.height * 0.5,
            vx: Math.random() * 8 + 4, vy: Math.random() * 4 + 2,
            len: Math.random() * 80 + 40, life: 1
          });
        }
        shooters = shooters.filter(function (s) {
          s.x += s.vx; s.y += s.vy; s.life -= 0.025;
          if (s.life <= 0) return false;
          ctx.strokeStyle = 'rgba(200,220,255,' + s.life * 0.7 + ')';
          ctx.lineWidth = 1.2;
          ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(s.x - s.vx * s.len / 10, s.y - s.vy * s.len / 10); ctx.stroke();
          return true;
        });
      }

      var raf;
      function draw() {
        ctx.clearRect(0, 0, c.width, c.height);
        drawStars();
        maybeShoot();
        raf = requestAnimationFrame(draw);
      }

      resize(); initStars(); draw();
      window.addEventListener('resize', function () { resize(); initStars(); });
    })();

    // â”€â”€ CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var canvas = document.getElementById('sim-canvas');
    var ctx = canvas.getContext('2d');

    function resizeCanvas() {
      var w = document.getElementById('canvas-wrap');
      canvas.width = w.offsetWidth; canvas.height = w.offsetHeight;
    }

    // â”€â”€ VIEW TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setView(v) {
      currentView = v;
      document.getElementById('vt-sim').className = v === 'sim' ? 'vtab active' : 'vtab';
      document.getElementById('vt-plot').className = v === 'plot' ? 'vtab active' : 'vtab';
      document.getElementById('canvas-wrap').style.display = v === 'sim' ? 'block' : 'none';
      document.getElementById('plot-wrap').style.display = v === 'plot' ? 'flex' : 'none';
    }

    // â”€â”€ WEBSOCKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function connectWS(onOpen) {
      if (ws && ws.readyState < 2) { ws.close(); }
      setStatus('spin', 'Connecting to REBOUND server...');
      ws = new WebSocket(WS_URL);
      ws.onopen = function () { setStatus('ok', 'Connected to REBOUND'); if (onOpen) onOpen(); };
      ws.onmessage = function (e) { handleWsMessage(JSON.parse(e.data)); };
      ws.onerror = function () { setStatus('err', 'WebSocket error â€” is websocket_server.py running?'); };
      ws.onclose = function () { setStatus('err', 'Disconnected from server'); };
    }
    function wsSend(obj) { if (ws && ws.readyState === 1) ws.send(JSON.stringify(obj)); }

    function handleWsMessage(msg) {
      if (msg.type === 'status') { setStatus('spin', msg.message); }
      else if (msg.type === 'error') { setStatus('err', msg.message); addMsg('err', msg.message); }
      else if (msg.type === 'scenario') {
        var d = msg.data;
        simState.scale = d.scale || 180;
        simState.scenarioName = d.name || '?';
        document.getElementById('hs-sc').textContent = (d.name || '?').slice(0, 12).toUpperCase();
        document.getElementById('hs-bd').textContent = d.N || '?';
        document.getElementById('hud-sc').textContent = (d.name || '').toUpperCase();
        document.getElementById('hud-info').textContent = d.N + ' BODIES';
        document.getElementById('hud-int').textContent = 'INTEGRATOR: ' + (d.integrator || '').toUpperCase();
        document.getElementById('hud-desc').textContent = d.description || '';
        document.getElementById('watermark').textContent = (d.name || '').toUpperCase();
        document.getElementById('empty-state').style.display = 'none';
        setStatus('ok', 'Simulation running: ' + d.name + (msg.source === 'ai' ? ' (AI-generated)' : ''));
        setView('sim'); simState.playing = true;
        addMsg('sys', (msg.source === 'ai' ? 'âš¡ AI-generated: ' : 'âœ“ Loaded: ') + d.name + ' â€” ' + d.N + ' bodies, ' + (d.integrator || '').toUpperCase());
      }
      else if (msg.type === 'frame') {
        renderFrame(msg.data);
        fpsCount++;
        var now = Date.now();
        if (now - fpsLast >= 1000) { fps = fpsCount; fpsCount = 0; fpsLast = now; document.getElementById('hs-fps').textContent = fps; }
      }
      else if (msg.type === 'elements') { showElements(msg.data); }
    }

    // â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var TYPE_GLOW = { star: 3.5, giant: 4.5, blackhole: 7, neutron: 6, dwarf: 3, planet: 2.8, debris: 1.5, asteroid: 1.5, moon: 2.5, comet: 4, spacecraft: 2 };

    function hexRgb(h) {
      h = h.replace('#', '');
      if (h.length === 3) h = h[0] + h[0] + h[1] + h[1] + h[2] + h[2];
      return parseInt(h.slice(0, 2), 16) + ',' + parseInt(h.slice(2, 4), 16) + ',' + parseInt(h.slice(4, 6), 16);
    }

    function renderFrame(data) {
      var W = canvas.width, H = canvas.height, cx = W / 2, cy = H / 2, scale = simState.scale;
      ctx.fillStyle = simState.showTrails ? 'rgba(0,0,12,' + simState.trailAlpha + ')' : '#00000c';
      ctx.fillRect(0, 0, W, H);
      document.getElementById('hs-t').textContent = (data.t || 0).toFixed(3);
      var dE = data.energy_drift || 0;
      var eb = document.getElementById('energy-badge');
      eb.textContent = 'Î”E/E: ' + dE.toExponential(1);
      eb.style.color = dE < 1e-6 ? '#00ff99' : dE < 1e-3 ? '#ffcc44' : '#ff4444';
      var bodies = data.bodies || []; simState.currentBodies = bodies;
      bodies.forEach(function (b) {
        var px = cx + b.x * scale, py = cy + b.y * scale, r = b.radius || 5;
        var rgb = hexRgb(b.color || '#ffffff'), gm = TYPE_GLOW[b.type] || 3;
        if (simState.showGlow) {
          var g1 = ctx.createRadialGradient(px, py, 0, px, py, r * gm * 3.2);
          g1.addColorStop(0, 'rgba(' + rgb + ',0.09)'); g1.addColorStop(1, 'rgba(' + rgb + ',0)');
          ctx.beginPath(); ctx.arc(px, py, r * gm * 3.2, 0, Math.PI * 2); ctx.fillStyle = g1; ctx.fill();
          var g2 = ctx.createRadialGradient(px, py, 0, px, py, r * gm);
          g2.addColorStop(0, 'rgba(' + rgb + ',0.65)'); g2.addColorStop(0.5, 'rgba(' + rgb + ',0.18)'); g2.addColorStop(1, 'rgba(' + rgb + ',0)');
          ctx.beginPath(); ctx.arc(px, py, r * gm, 0, Math.PI * 2); ctx.fillStyle = g2; ctx.fill();
        }
        ctx.beginPath(); ctx.arc(px, py, r, 0, Math.PI * 2); ctx.fillStyle = b.color || '#ffffff'; ctx.fill();
        if (r > 4 && simState.showGlow) {
          var gs = ctx.createRadialGradient(px - r * .3, py - r * .3, 0, px, py, r);
          gs.addColorStop(0, 'rgba(255,255,255,0.45)'); gs.addColorStop(0.5, 'rgba(255,255,255,0.1)'); gs.addColorStop(1, 'rgba(255,255,255,0)');
          ctx.beginPath(); ctx.arc(px, py, r, 0, Math.PI * 2); ctx.fillStyle = gs; ctx.fill();
        }
        if (b.type === 'blackhole') {
          [1.8, 2.5, 3.4].forEach(function (m, i) {
            ctx.beginPath(); ctx.arc(px, py, r * m, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(' + rgb + ',' + (0.5 - i * 0.14) + ')';
            ctx.lineWidth = 1.8 - i * 0.4; ctx.stroke();
          });
        }
        if (simState.showLabels && bodies.length <= 24) {
          ctx.font = '600 9px "Syne",sans-serif';
          ctx.fillStyle = 'rgba(180,215,255,0.65)';
          ctx.fillText(b.name, px + r + 5, py + 3);
        }
      });
      updateBodyStrip(bodies);
    }

    function updateBodyStrip(bodies) {
      var strip = document.getElementById('body-strip');
      if (!strip) return;
      if (bodies.length !== strip.children.length) {
        strip.innerHTML = '';
        bodies.slice(0, 8).forEach(function (b) {
          var d = document.createElement('div'); d.className = 'bstrip-item';
          d.id = 'bsi-' + b.name.replace(/\s/g, '_');
          d.innerHTML = '<div class="bstrip-dot" style="background:' + b.color + '"></div>'
            + '<span class="bstrip-name">' + b.name + '</span>'
            + ' <span class="bstrip-v" id="bsv-' + b.name.replace(/\s/g, '_') + '">â€”</span>';
          strip.appendChild(d);
        });
      }
      bodies.slice(0, 8).forEach(function (b) {
        var el = document.getElementById('bsv-' + b.name.replace(/\s/g, '_'));
        if (el) el.textContent = 'v=' + b.speed.toFixed(2);
      });
    }

    // â”€â”€ SIM CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startSim(prompt) {
      var go = document.getElementById('sim-go');
      go.disabled = true; go.textContent = 'â³';
      setStatus('spin', 'Requesting: ' + prompt);
      connectWS(function () {
        wsSend({ action: 'start', prompt: prompt, fps: 30, steps_per_frame: simState.speedMult });
        go.disabled = false; go.textContent = 'â–¶';
      });
    }

    document.getElementById('sim-go').addEventListener('click', function () {
      var p = document.getElementById('sim-input').value.trim(); if (p) startSim(p);
    });
    document.getElementById('sim-input').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') { var p = this.value.trim(); if (p) startSim(p); }
    });

    // CHIPS
    var EXAMPLES = ['Real solar system', 'Two neutron stars spiraling', 'TRAPPIST-1 system', 'Black hole + 5 stars', 'Figure-8 three body', 'Hot Jupiter + super-Earth', 'Alpha Centauri triple', 'Jupiter Galilean moons', 'Rogue star flyby', 'Binary stars e=0.7', 'Protoplanetary disk'];
    (function () {
      var cl = document.getElementById('chip-list');
      EXAMPLES.forEach(function (ex) {
        var d = document.createElement('div'); d.className = 'chip'; d.textContent = ex;
        d.addEventListener('click', function () { document.getElementById('sim-input').value = ex; startSim(ex); });
        cl.appendChild(d);
      });
    })();

    // PAUSE / RESET / CONTROLS
    document.getElementById('btn-pause').addEventListener('click', function () {
      simState.playing = !simState.playing;
      wsSend({ action: simState.playing ? 'resume' : 'pause' });
      this.textContent = simState.playing ? 'â¸ Pause' : 'â–¶ Play';
      this.className = simState.playing ? 'btn on' : 'btn';
    });
    document.getElementById('btn-reset').addEventListener('click', function () { wsSend({ action: 'reset' }); });
    document.getElementById('btn-trail').addEventListener('click', function () {
      simState.showTrails = !simState.showTrails; this.className = simState.showTrails ? 'btn on' : 'btn';
    });
    document.getElementById('btn-glow').addEventListener('click', function () {
      simState.showGlow = !simState.showGlow; this.className = simState.showGlow ? 'btn on' : 'btn';
    });
    document.getElementById('btn-lbl').addEventListener('click', function () {
      simState.showLabels = !simState.showLabels; this.className = simState.showLabels ? 'btn on' : 'btn';
    });
    document.getElementById('btn-elems').addEventListener('click', function () { wsSend({ action: 'get_elements' }); });
    document.getElementById('spd-sl').addEventListener('input', function () {
      simState.speedMult = parseInt(this.value);
      document.getElementById('spd-v').textContent = simState.speedMult + 'Ã—';
      wsSend({ action: 'set_speed', multiplier: simState.speedMult });
    });
    document.getElementById('trl-sl').addEventListener('input', function () {
      var v = parseInt(this.value);
      var labels = ['', 'Very Long', 'Long', 'Long', 'Medium', 'Medium', 'Short', 'Short', 'Fast', 'Very Fast', 'Instant'];
      simState.trailAlpha = v * 0.025 + 0.015;
      document.getElementById('trl-v').textContent = labels[v];
    });

    // â”€â”€ ORBITAL ELEMENTS DISPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showElements(elements) {
      if (!elements || !elements.length) return;
      var txt = 'ğŸ“ Orbital Elements:\n';
      elements.forEach(function (el) { txt += el.name + ': a=' + el.a + ' AU  e=' + el.e + '  P=' + el.P + ' yr\n'; });
      addMsg('a', { text: txt });
    }

    // â”€â”€ STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setStatus(state, msg) {
      var dot = document.getElementById('status-dot');
      dot.className = ''; dot.classList.add(state);
      document.getElementById('status-txt').textContent = msg;
    }

    // â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function fillChat(t) { document.getElementById('chat-in').value = t; document.getElementById('chat-in').focus(); }
    function fillSim(t) { document.getElementById('sim-input').value = t; startSim(t); }

    function checkAPI() {
      fetch(API + '/api/health')
        .then(function (r) { return r.json(); })
        .then(function (d) {
          document.getElementById('api-dot').className = 'api-dot on';
          document.getElementById('api-lbl').textContent = 'REBOUND ' + d.rebound + '  Â·  RAG ' + d.rag_docs + ' docs  Â·  Online';
        })
        .catch(function () {
          document.getElementById('api-dot').className = 'api-dot off';
          document.getElementById('api-lbl').textContent = 'API Offline â€” run websocket_server.py';
        });
    }

    function addMsg(type, content) {
      var msgs = document.getElementById('chat-msgs');
      var div = document.createElement('div');
      if (type === 'u') { div.className = 'msg msg-u'; div.textContent = content; }
      else if (type === 'sys') { div.className = 'msg msg-sys'; div.textContent = content; }
      else if (type === 'err') { div.className = 'msg msg-err'; div.textContent = content; }
      else {
        div.className = 'msg msg-a';
        div.innerHTML = '<div class="msg-a-tag">AI Â· Llama 3.1</div>';
        var p = document.createElement('p'); p.textContent = content.text || ''; div.appendChild(p);
        if (content.data) {
          var tbl = document.createElement('table'); tbl.className = 'dtable';
          Object.entries(content.data).forEach(function (kv) {
            if (typeof kv[1] === 'object') return;
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + String(kv[0]).replace(/_/g, ' ') + '</td><td>' + kv[1] + '</td>';
            tbl.appendChild(tr);
          });
          div.appendChild(tbl);
        }
        if (content.plot) {
          var img = document.createElement('img'); img.className = 'chat-plot';
          img.src = 'data:image/png;base64,' + content.plot;
          img.addEventListener('click', function () {
            var pi = document.getElementById('plot-img');
            pi.src = img.src; pi.style.display = 'block';
            document.getElementById('plot-empty').style.display = 'none';
            setView('plot');
          });
          div.appendChild(img);
        }
      }
      msgs.appendChild(div); msgs.scrollTop = msgs.scrollHeight;
    }

    function addTyping() {
      var msgs = document.getElementById('chat-msgs');
      var d = document.createElement('div'); d.className = 'msg msg-a typing'; d.id = 'typing';
      d.innerHTML = '<span></span><span></span><span></span>';
      msgs.appendChild(d); msgs.scrollTop = msgs.scrollHeight;
    }
    function removeTyping() { var t = document.getElementById('typing'); if (t) t.remove(); }

    function sendMsg() {
      var inp = document.getElementById('chat-in');
      var msg = inp.value.trim(); if (!msg) return;
      addMsg('u', msg); inp.value = '';
      document.getElementById('send').disabled = true; addTyping();
      fetch(API + '/api/chat', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg })
      })
        .then(function (r) { return r.json(); })
        .then(function (data) {
          removeTyping(); addMsg('a', { text: data.text, data: data.data, plot: data.plot });
          if (data.plot) {
            var pi = document.getElementById('plot-img');
            pi.src = 'data:image/png;base64,' + data.plot; pi.style.display = 'block';
            document.getElementById('plot-empty').style.display = 'none'; setView('plot');
          }
          if (data.sim_prompt) {
            document.getElementById('sim-input').value = data.sim_prompt;
            addMsg('sys', 'âš¡ Auto-launching simulation...');
            setTimeout(function () { startSim(data.sim_prompt); }, 500);
          }
          document.getElementById('send').disabled = false;
        })
        .catch(function () {
          removeTyping(); addMsg('err', 'Connection failed â€” is the server running?');
          document.getElementById('send').disabled = false;
        });
    }

    // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.addEventListener('load', function () {
      resizeCanvas(); checkAPI(); setInterval(checkAPI, 30000);
      document.getElementById('send').addEventListener('click', sendMsg);
      document.getElementById('chat-in').addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
      });
      window.addEventListener('resize', function () {
        resizeCanvas();
        ctx.fillStyle = '#00000c'; ctx.fillRect(0, 0, canvas.width, canvas.height);
      });
    });
  </script>
</body>

</html>