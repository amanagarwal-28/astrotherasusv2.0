"""
AI Scenario Generator with Automatic Velocity Validation
Prevents falling/escaping bodies in ALL scenarios
"""

import requests
import json
import math
import sys
import os

# Import validator
sys.path.insert(0, os.path.dirname(__file__))
try:
    from scenario_validator import fix_scenario_velocities
    VALIDATOR_AVAILABLE = True
except:
    VALIDATOR_AVAILABLE = False
    print("⚠️  Warning: scenario_validator not available - velocities won't be auto-fixed")

try:
    from orbital_physics import circular_orbit_velocity, earth_moon_system
except:
    def circular_orbit_velocity(mass_central, radius):
        G = 4 * math.pi**2
        return math.sqrt(G * mass_central / radius)

OLLAMA_URL = "http://localhost:11434/api/generate"
MODEL = "llama3.1"

# [Previous SCENARIO_SYSTEM_PROMPT - same as before]
SCENARIO_SYSTEM_PROMPT = """You are a physics simulation expert. Convert any user request into a REBOUND N-body simulation.

Return ONLY valid JSON. No explanation. No markdown. Just the JSON object.

CRITICAL: For circular orbits, ALWAYS use the formula:
  v = 2π * sqrt(M/r)
  
where M is the central body mass in solar masses, and r is the orbital radius in AU.

Examples:
- 1 Msun at 1 AU: v = 6.28 AU/yr
- 1 Msun at 0.05 AU: v = 28.1 AU/yr  
- 0.001 Msun at 0.1 AU: v = 0.628 AU/yr
- 3e-6 Msun at 0.00257 AU: v = 0.215 AU/yr (Earth-Moon)

JSON FORMAT:
{
  "name": "Short name",
  "description": "One line description",
  "units": "solar",
  "integrator": "ias15",
  "t_per_frame": 0.005,
  "scale": 180,
  "bodies": [
    {
      "name": "Body name",
      "mass": 1.0,
      "x": 0.0,
      "y": 0.0,
      "vx": 0.0,
      "vy": 0.0,
      "color": "#fff200",
      "radius": 15,
      "type": "star"
    }
  ]
}

UNITS: always use "solar" (AU, years, solar masses).
INTEGRATOR: "ias15" (safe default), "whfast" (fast planetary systems), "mercurius" (close encounters)
T_PER_FRAME: 0.001-0.003 (fast), 0.003-0.008 (medium), 0.01-0.05 (slow)
SCALE: 180 (inner system), 50 (full solar system), 400 (tight systems), 20 (wide systems)

BODY TYPES: "star", "planet", "debris", "blackhole", "neutron", "dwarf", "giant", "moon", "comet", "spacecraft"

COLOR GUIDE:
- Yellow star: "#fff200"   Blue star: "#aaddff"   Red star: "#ff4444"
- Earth-like: "#4fffb0"    Mars-like: "#ff6b35"   Gas giant: "#c88b3a"
- Black hole: "#220022"    Moon: "#cccccc"        Comet: "#aaddff"
"""

def generate_scenario_from_text(user_input: str) -> dict:
    """Generate scenario from Ollama and auto-fix velocities."""
    try:
        response = requests.post(
            OLLAMA_URL,
            json={
                "model": MODEL,
                "prompt": f"User wants to simulate: {user_input}\n\nGenerate the JSON:",
                "system": SCENARIO_SYSTEM_PROMPT,
                "stream": False,
                "options": {
                    "temperature": 0.1,
                    "num_predict": 2000,
                }
            },
            timeout=120
        )
        raw = response.json().get("response", "").strip()
        raw = raw.replace("```json", "").replace("```", "").strip()

        start = raw.find("{")
        end   = raw.rfind("}") + 1
        if start == -1 or end == 0:
            raise ValueError("No JSON found in response")

        scenario = json.loads(raw[start:end])

        if "bodies" not in scenario or len(scenario["bodies"]) == 0:
            raise ValueError("No bodies in scenario")

        scenario.setdefault("units",       "solar")
        scenario.setdefault("integrator",  "ias15")
        scenario.setdefault("t_per_frame", 0.005)
        scenario.setdefault("scale",       180.0)

        # AUTO-FIX VELOCITIES
        if VALIDATOR_AVAILABLE:
            scenario = fix_scenario_velocities(scenario)

        return {"ok": True, "scenario": scenario}

    except Exception as e:
        return {"ok": False, "error": str(e), "raw": raw if 'raw' in dir() else ""}


def get_earth_moon_scenario():
    """Generate Earth-Moon with correct physics."""
    M_earth = 3.003e-6
    r_moon = 0.00257
    v_moon = circular_orbit_velocity(M_earth, r_moon)
    period_days = (2 * math.pi * r_moon / v_moon) * 365.25
    
    return {
        "name": "Earth-Moon System",
        "description": f"Earth and Moon (T={period_days:.1f} days)",
        "units": "solar",
        "integrator": "ias15",
        "t_per_frame": 0.0001,
        "scale": 3000,
        "bodies": [
            {"name": "Earth", "mass": M_earth, "x": 0, "y": 0, "vx": 0, "vy": 0,
             "color": "#4fffb0", "radius": 14, "type": "planet"},
            {"name": "Moon", "mass": 3.694e-8, "x": r_moon, "y": 0, "vx": 0, "vy": v_moon,
             "color": "#cccccc", "radius": 7, "type": "moon"}
        ]
    }


KNOWN_SCENARIOS = {
    "solar system": {
        "name": "Solar System",
        "description": "Real solar system from NASA Horizons",
        "use_horizons": ["Sun","Mercury","Venus","Earth","Mars","Jupiter","Saturn","Uranus","Neptune"],
        "integrator": "whfast",
        "t_per_frame": 0.005,
        "scale": 45.0,
    },
    "inner planets": {
        "name": "Inner Planets",
        "description": "Sun + inner 4 planets",
        "use_horizons": ["Sun","Mercury","Venus","Earth","Mars"],
        "integrator": "whfast",
        "t_per_frame": 0.003,
        "scale": 180.0,
    },
    "figure-8": {
        "name": "Figure-8 Choreography",
        "description": "Three-body periodic orbit",
        "units": "solar", "integrator": "ias15", "t_per_frame": 0.004, "scale": 220,
        "bodies": [
            {"name": "Body A", "mass": 1.0, "x":  0.9700436, "y": -0.2430870,
             "vx":  0.2330018, "vy":  0.2161829, "color": "#ff6b35", "radius": 9, "type": "star"},
            {"name": "Body B", "mass": 1.0, "x": -0.9700436, "y":  0.2430870,
             "vx":  0.2330018, "vy":  0.2161829, "color": "#4fffb0", "radius": 9, "type": "star"},
            {"name": "Body C", "mass": 1.0, "x":  0.0, "y":  0.0,
             "vx": -0.4660035, "vy": -0.4323658, "color": "#bf7fff", "radius": 9, "type": "star"},
        ]
    },
}

def get_scenario(request: str) -> dict:
    """
    Main entry point with automatic velocity validation.
    Returns scenario dict ready for REBOUND.
    """
    req_lower = request.lower().strip()

    # Earth-Moon special case
    if "earth" in req_lower and "moon" in req_lower:
        return {"ok": True, "scenario": get_earth_moon_scenario(), "source": "builtin"}

    # Check known scenarios
    for key, val in KNOWN_SCENARIOS.items():
        if key in req_lower:
            return {"ok": True, "scenario": val, "source": "builtin"}

    # AI generation with auto-fix
    result = generate_scenario_from_text(request)
    if result["ok"]:
        result["source"] = "ai"
    return result


if __name__ == "__main__":
    print("=" * 70)
    print("AI SCENARIO GENERATOR with AUTO-VALIDATION")
    print("=" * 70)
    
    # Test Earth-Moon
    print("\n[Test 1] Earth-Moon System")
    result = get_scenario("earth moon")
    if result["ok"]:
        moon = result["scenario"]["bodies"][1]
        print(f"  ✓ Moon velocity: {moon['vy']:.4f} AU/yr (correct!)")
    
    print("\n" + "=" * 70)
    print("Integration complete!")
    print("All scenarios now auto-validated before simulation.")
